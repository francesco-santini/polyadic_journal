\documentclass[preprint,12pt]{elsarticle}

\usepackage{mathptmx}

\usepackage{amsmath,amssymb,amsxtra,amsfonts,cancel}
\usepackage{graphicx,paralist}
\usepackage{url}
\usepackage{tikz-cd}
\usetikzlibrary{trees, arrows}
\usepackage{xspace}
\usepackage{setspace}
\usepackage{tikz}
\usepackage{textcomp}
\usepackage{soul}
\usepackage{listings}
\usepackage{mathtools}

\usepackage{todonotes}




\def\bigodiv{ {\text{ \large $\mathbf\odiv\hspace{-9.3pt} \div$}} }
\def\bigominus{ {\text{ \large $\mathbf\odiv\hspace{-9.3pt} -$}} }


\newtheorem{definition}{Definition}
\newtheorem{remark}{Remark}
\newtheorem{lemma}{Lemma}
\newtheorem{proof}{Proof}
\newtheorem{proposition}{Proposition}
\newtheorem{theorem}{Theorem}
\newtheorem{example}{Example}


%\defodiv{{ \odiv\hspace{-7.5pt} \div}}
\def\0{{\mathbf 0}}
\def\1{{\mathbf 1}}
\def\C{{\mathcal C}}
\newcommand{\rrarrow}{\longrightarrow}
\newcommand{\diag}[2]{d_{{#1}{#2}}}
\newcommand{\comment}[1]{}
\newcommand{\tell}{{\bf tell}}
\newcommand{\atell}{{\bf atell}}
\newcommand{\ask}{{\bf ask}}
\newcommand{\ostop}{{\bf stop}}
\newcommand{\retract}{{\bf retr}}
\newcommand{\rarrow}{\rightarrow}
\newcommand{\remove}{\rightarrow}
%introdotto per rimuovere le prove
\newcommand{\shortNoProof}[1]{ }

\def\ent{\vdash}
\def\monid{{\mathbf 0}}
\def\1{{\mathbf 1}}
\def\C{{\mathcal C}}
\def\K{{\mathcal K}}
\long\def\comment#1{}
\def\monop{\otimes}
\def\odiv{\, {\ominus\hspace{-7.7pt} \div} \,}
\def\apexodiv{\, {\ominus\hspace{-5.7pt} \div} \,}
\def\monid{\mathbf{1}}

\newcommand{\SCCP}{\texttt{SCCP}\xspace}
\newcommand{\RefFig}[1]{Figure \nolinebreak\ref{#1}}
\newcommand\fnsep{\textsuperscript{,}}





\begin{document}


\begin{frontmatter}
\title{To be defined}
    \author[lb]{Laura Bussi}
	\ead{laura.bussi@phd.unipi.it}
\author[fb]{Fabio~Gadducci\corref{cor1}}
    \ead{gadducci@di.unipi.it}
    \author[fs]{Francesco~Santini\corref{cor2}\fnref{fn2}}
    \ead{francesco.santini@dmi.unipg.it}
 
\cortext[cor1]{Principal corresponding author.}
\cortext[cor2]{Secondary corresponding author.}


\address[fb]{Dipartimento di Informatica, Universit\`a di Pisa, Italy}
\address[lb]{Dipartimento di Informatica, Universit\`a di Pisa, Italy}
\address[fs]{Dipartimento di Matematica e Informatica, Universit\`a di Perugia, Italy}


\begin{abstract}
	To be added
\end{abstract}


%\maketitle
\end{frontmatter}



\section{Introduction}\label{sec:intro}

\todo[inline]{To be defined}





\section{An introduction to Residuated Monoids}\label{sec:bg}

This section reports some results on residuated monoids,
which are the algebraic structure adopted for modelling
soft constraints in the following of the paper.
These background results are mostly drawn from~\cite{jlamp17}, where also proofs can be found.


\subsection{Preliminaries on Ordered Monoids}\label{sec:lem}

The first step is to define an algebraic structure for modelling preferences,
where it is possible to compare values and combine them.
Our choice falls into the range of \emph{bipolar} approaches, in order 
to represent both positive and negative preferences: 
we refer to~\cite{ipl17} for a detailed introduction and 
a comparison with other proposals.

\begin{definition}[Orders]
	A partial order (PO) is a pair $\langle A, \leq \rangle$ such that
	$A$ is a set %of values 
	and $\leq \,\,\subseteq A \times A$ is a reflexive, transitive, and
	anti-symmetric  relation.
	% and $\forall a \in A. \bot\leq a$.
	%
	%A partial order with bottom (POT) is a triple
	%$\langle A, \leq, \bot \rangle$ such that $\langle A, \leq \rangle$ is a PO and
	%$\forall a \in A. \bot \leq a$.
	%
	A semi-lattice (SL) is a PO
	such that any non-empty finite subset of $A$ has a least upper bound (LUB).
\end{definition}

%We write 
The LUB of a (possibly infinite or empty) subset $X \subseteq A$ is denoted $\bigvee X$, and it is clearly unique.
Should  they exist, $\bigvee A$ and $\bigvee \emptyset$ correspond respectively to the top, denoted as 
$\top$, and to the bottom, denoted as $\bot$, of the PO.

\comment{\begin{definition}[Compact elements]
		An element $a \in A$ is compact 
		%(or finite) 
		if whenever $a \leq \bigvee Y$ for some $Y \subseteq A$
		there exists a finite subset
		$X \subseteq Y$ such that $a \leq \bigvee X$.
		%
		%Let $A^C \subseteq A$ be the set of compact elements of ${\mathbb C}$.
		%Then ${\mathbb C}$ is algebraic if $\forall c \in A. c = \bigvee \{ d \in A^C \mid d \leq c\}$.
	\end{definition}
	
	We let $A^C \subseteq A$ denote the set of compact elements of ${\mathbb C}$. }

%We considered the LUBs of possibly infinite sets just for the sake of simplicity: 
%our proposal would fit also the finite case.
%
%Obviously, Ls also have the greatest lower bound for any subset $Y \subseteq A$.
%In the following we fix a BL ${\mathbb L} = \langle A, \leq, \monid \rangle$.

%\begin{definition}[compact elements]
%An element $a \in A$ is compact (or finite) if whenever $a \leq \bigvee Y$ there exists a finite subset
%$X \subseteq Y$ such that $a \leq \bigvee X$.
%%
%%Let $A^C \subseteq A$ be the set of compact elements of ${\mathbb C}$.
%%Then ${\mathbb C}$ is algebraic if $\forall c \in A. c = \bigvee \{ d \in A^C \mid d \leq c\}$.
%\end{definition}


%Note that for complete lattices the definition of compactness given above coincides with the one using
%directed subsets. It will be easier to generalize it, though, to compactness with respect to the monoidal operator (see Def.~\ref{def:compactness}).
%
%We let $A^C \subseteq A$ denote the set of compact elements of ${\mathbb C}$. Note however
%that $A^C$ might be trivial: indeed, in the the segment $[0, 1]$ of the reals
%with the usual order, only $0$ is a compact element. As we are going to see, the situation for the soft paradigm
%can be more nuanced.
%\marginpar{is algebraicity needed?}
%

\begin{definition}[Ordered monoids]\label{defn:clm}
	A (commutative) monoid is a triple
	$\langle A, \monop,$ $\1 \rangle$ such that $\monop: A \times A \rightarrow A$ is
	a commutative and associative function and $\1 \in A$ is its \emph{identity} element,
	i.e., $\forall a \in A. a \monop \1 = a$.
	%	
	A partially ordered monoid (POM) is a 4-tuple $\langle A, {\leq,} \monop, \1 \rangle$ such that 	
	$\langle A, \leq \rangle$ is a PO and $\langle A, \monop, \1 \rangle$ a monoid.
	%
	A semi-lattice monoid (SLM) is a 
	POM such that their underlying PO is a SL.
\end{definition}

As usual, we use the infix notation: $a \monop b$ stands for $\monop(a,b)$.
\comment{The monoidal operator can be defined for any multi-set: it is given 
	for a family of elements $a_i \in A$ indexed over a non-empty finite
	set $I$, and it is denoted by
	$\bigotimes_{i \in I} a_i$.
	%
	If for an index set $I$ the $a_i$'s are different,
	we write $\bigotimes S$ instead of $\bigotimes_{i \in I} a_i$
	for the set $S = \{a_i \mid i \in I\}$.
	%
	Conventionally, we denote $\bigotimes \emptyset = \bot$.
}

\begin{example}[Power set]\label{ex:powerset}
	Given a (possibly infinite) set $V$ of variables, we consider
	the monoid $\langle 2^V, \cup, \emptyset \rangle$
	of (finite, possibly empty) subsets of $V$, with union as the monoidal operator.
	Since the operator is idempotent (i.e., $\forall a\in A.\, a \monop a = a$), 
	the natural order ($\forall a, b \in A.\, a \leq b$ iff $a \monop b = b$) 
	is a partial order, and 
	it coincides with subset inclusion:
	in fact, $\langle 2^V, \subseteq, \cup, \emptyset \rangle$
	is an SLM.
\end{example}

In general, the partial order $\leq$ and the multiplication operator $\otimes$ can be unrelated.
This is not the case for distributive SLMs.

\begin{definition}[Distributivity]
	\label{dist}
	Let $\langle A, \leq, \monop, \monid \rangle$ be an SLM.
	It is distributive if
	for  any  non-empty finite  $X \subseteq A$
	%	\begin{itemize}
	it holds $\forall a \in A.\,  a \monop  \bigvee X = \bigvee \{a \monop x \mid x \in X\}$.
	%	\end{itemize}
\end{definition}

Note that distributivity implies that $\otimes$ is monotone with respect to $\leq$.
\begin{remark}
	% i.e., it holds
	%	\begin{itemize}
	%		%\item 
	%		$\forall a, b, c \in A. a \leq b \implies c \monop a \leq c \monop b$.
	%	\end{itemize}
	
	It is almost straightforward to show that our proposal encompasses many other formalisms in the literature.
	Indeed, distributive semi-lattice monoids are \emph{tropical} semirings (also known as dioids), 
	namely, semirings with an idempotent sum operator $a \oplus b$, which in our formalism is obtained as
	$\bigvee \{a, b\}$.
	% that is idempotent.
	%~\cite{tropical}. 
	If $\monid$ is the top of the SL we end up 
	in \emph{absorptive} semirings~\cite{golanShort}, 
	which are known as $c$-semirings 
	in the soft constraint jargon~\cite{jacm97} (see e.g.~\cite{ecai06} for a brief survey on residuation 
	for such semirings).
	Note that requiring the monotonicity of $\otimes$ and imposing $\monid$ to be the top of the partial order
	means that preferences are negative, i.e., 
	that it holds $\forall a, b \in A. a \monop b \leq a$.
\end{remark}

%\begin{example}
%Given a (possibly infinite) set $V$ of variables, two semi-lattice monoids are going to play a key role in the following sections. The first one is the semi-lattice monoid 
%$\mathbb{M}(V) = \langle 2^V_{fin}, \subseteq, \cup, \emptyset \rangle$
%of finite sub-sets of $V$, with the usual order given by sub-set inclusion.
%For the second one, we start by defining the support of an endofunction $f\colon V \to V$ as the set $sv(f) = \{ x \in V \mid f(x)\neq x \}$ and
%$F(V)$ as the set of functions $f\colon V \to V$ with finite support.
%The semi-lattice monoid of interest is  $\mathbb{F}(V) = \langle F(V), id, \circ, \iota \rangle$ where 
%$\iota$ is the identity function,  $\circ$ is function composition and $id$ is the discrete ordering on $F(V)$.
%\end{example}
%
%\bigskip
%
% COMMENTATO DA FILIPPO
%
%\begin{remark}
%The developments reported in Section~\ref{cypo} could be stated also for \emph{infinite} subsets 
%and for functions whose support is not necessarily finite. More on this later on.
%\end{remark}

%$a, b \in A$.
%
%The monoidal operator can be defined for any finite multiset: it is given for a family of elements
%$a_i \in A$ indexed over a finite set $I$, and it is denoted by
%$\bigotimes_{i \in I} a_i$.
%%
%Whenever for an index $I$ all the $a_i$'s are different,
%we simply write $\bigotimes S$ instead of $\bigotimes_{i \in I} a_i$
%for the set $S = \{a_i \mid i \in I\}$.
%%
%Conventionally, we will also usually denote $\bigotimes \emptyset = \top$.
%
%%smallskip
%%In the following we fix a IM ${\mathbb M} = \langle A, \monop, \monid \rangle$.
%
%We now move our attention to the domain of values we are going to consider.

\subsection{Remarks on residuation}\label{sec:ror}
It is often needed to be able to ``remove'' part of a preference, due e.g. 
to the non-monotone nature of the language at hand
for manipulating constraints. 
%
The structure of our choice is given by residuated monoids~\cite{golanShort}. 
%
They introduce a new operator $\odiv$, which represents a ``weak'' (due to the presence of partial orders) inverse of $\otimes$.

\begin{definition}[Residuation]\label{def:repo}
	A residuated POM is a 5-tuple $\langle A, \leq, \monop, \odiv, \monid \rangle$ such that
	$\langle A, \leq, \monop, \monid \rangle$ is a partially ordered monoid and
	$\odiv: A \times A \rightarrow A$ is a function satisfying $\forall a, b, c \in A. b \monop c \leq a \iff c \leq a \odiv b$. A residuated SLM is a
	residuated POM such that the underlying PO is a SL.
\end{definition}

%In the following sections on oft CCP, we will often use absorptive RePOs, i.e., such that 
%	\begin{itemize}
%		\item[] $\forall a, \in A. a \leq 1$.
%	\end{itemize}
%
%However, 

%Residuation is monotone on the first argument: 
%$\forall a, b, c \in A. a \leq b \implies a \odiv c \leq b \odiv c$.
%Among other things, n
In order to confirm the intuition about weak inverses,
Lemma~\ref{rclm1} below precisely states that residuation conveys the meaning of 
an approximated form of subtraction.
% which can be used to remove a constraint from another.
% operator.
%
%We can give an order characterisation of the residuation operator.

\begin{lemma}\label{rclm1}
	Let $\langle A,$ $\leq, \otimes,  \odiv, \1 \rangle$ be a residuated POM with bottom.
	Then $a \odiv b = \bigvee \{c \mid b \otimes c \leq a\}$ for all $a, b \in A$.
\end{lemma}

In words, the LUB of the (possibly infinite) set 
$\{c \mid b \otimes c \leq a\}$ exists and is equal to $a \odiv b$.
%
In fact, residuation implies distributivity (see~\cite[Lemma 2.2]{ipl17}).

\begin{lemma}\label{rclm2}
	Let $\langle A, \leq, \monop, \odiv, \1 \rangle$ be a residuated POM. 
	Then $\monop$ is monotone.
	If additionally it is a SLM, then it is distributive.
\end{lemma}



In any residuated POM the $\odiv$ operator is also monotone on the first argument and 
anti-monotone on the second one, i.e., 
$\forall a, b, c \in A.\, a\leq b \implies  c\odiv b \leq c \odiv a$.
%
Other easy to prove properties are
$\forall a\in A. \monid \leq a \odiv a$ and
$\forall a, b \in A. a \leq b \implies b \monop (a \odiv b) \leq a$.
These latter facts suggests the definition below, which identifies sub-classes 
of residuated monoids that are suitable for an easier manipulation
of constraints (see e.g.~\cite{ecai06}).

\begin{definition}[Families of POMs]
	A residuated POM $\langle A, \leq, \monop, \odiv, \monid \rangle$ is
	\begin{itemize}
		\item
		\emph{localised} if $\forall a \in A. a \not \in \{\bot,\top\} \implies a \odiv a = \1$;
		\item
		\emph{invertible} if $\forall a, b \in A. a \leq b \implies b \monop (a \odiv b) = a$;
		\item
		\emph{cancellative} if $\forall a, b, c \in A. a \not \in \{\bot,\top\} \wedge a \otimes b = a  \otimes c \implies b = c$.
	\end{itemize}
\end{definition}

\begin{remark}
	When introduced in~\cite[Def.~2.4]{ipl17}, localisation was equivalently stated as 
	$\forall a, b \in A. \bot < a \leq b<\top \implies a \odiv b \leq \1$.
	Indeed, the latter implies $a \odiv a \leq \1$, while  $\1 \leq a \odiv a$
	by definition. Now, assuming $a \odiv a = \1$ and $a \leq b$, 
	by anti-monotonicity $a \odiv b \leq a \odiv a = \1$.
	Note the constraint on $a \not \in \{\bot,\top\}$: indeed, if a residuated POM 
	has a bottom element then it also has a top element and moreover 
	$a \odiv \bot = \top \odiv a = \top$ for any  $a$.
	
	Note that being cancellative is a strong requirement. It implies e.g. 
	some uniqueness of invertibility, that is, for any $a, b$ there exists 
	at most a $c$ such that $b\otimes c = a$.
	It is moreover equivalent to what we could call strongly locality,
	that is, $\forall a, b \in A. a \not \in \{\bot,\top\} \implies (a \otimes b) \odiv a = b$. 
	Indeed, this property implies cancellativeness, since if $a \otimes b = a \otimes c$ 
	then $b = (a \otimes b) \odiv a = (a \otimes c) \odiv a = c$. On the other side,
	it is implied, since 
	$((a \otimes b) \odiv a)\otimes a = a \otimes b$ holds in residuated POMs.
\end{remark}

\comment{
	In order to ease the verification of the algebraic structure, it is often needed
	a characterisation of residuation via simpler properties,
	as the ones given below.
	
	\begin{lemma}
		\label{mono}
		Let $\langle A, \leq, \monop, \monid \rangle$ be a POM  and
		$\odiv: A \times A \rightarrow A$ a function. Then we have $\langle A, \leq, \monop, \odiv, \monid \rangle$ is a residuated POM if and only if
		\begin{itemize}
			\item $\forall a, b \in A. b \monop (a \odiv b) \leq a \leq (b \monop a) \odiv b$,
			\item $\forall a, b, c \in A.\, a \leq b \implies a \otimes c \leq b \otimes c$ and $a\odiv c \leq b \odiv c$.
		\end{itemize}
	\end{lemma}
	
	
	%\marginpar{all RePO are localized?}
	
	%\begin{remark}
	%	Note that the equivalence $a \otimes ((a \otimes b) \odiv a) = a \otimes b$ always holds, even if the 
	%	underlying RePO is not invertible. Indeed, we have by definition $a \otimes ((a \otimes b) \odiv a) 
	%	\leq a \otimes b$, as $(a \otimes b) \odiv a \leq b$. We must check that $a \otimes ((a \otimes b) 
	%	\odiv a) \leq a \otimes b \iff b \leq ((a \otimes b) \odiv a) \iff a \otimes b \leq a \otimes b$,
	%	which is trivially true.
	%\end{remark}
	
	\begin{remark}\label{rmk:soft}
		Some well-known structures used with soft constraints are the 
		%\emph{Boolean} ($\langle \{\mathit{false},\mathit{true}\}, \mathit{false} \leq \mathit{true}, \wedge, \mathit{false}, \mathit{true}\rangle$), 
		\emph{Fuzzy} ($\langle [0,1],$ $\leq, \min, 1 \rangle$), \emph{Probabilistic} ($\langle [0,1], {\leq,} \allowbreak\times, 1 \rangle$), 
		and \emph{Tropical}   ($\langle \mathbb{R}^+, \geq, +, 0 \rangle$) semirings, for $\geq$ the inverse of the standard order 
		(thus $0$ the top of the SL). In all these cases the underlying monoids 
		are both invertible and localised, thus
		%
		the $\odiv$ operator can be also used to
		(partially) relax constraints (see again~\cite{ecai06}).
	\end{remark}
}


\comment{
	%Note that the proof does not require that $\otimes$ is monotone, which is thus a derived property.
	%
	Distributivity holds also for the empty set and for infinite sets, if the necessary LUBs exist.
	%
	Instead, it holds only partially for $\odiv$: this follows directly from the monotonicity of $\odiv$ on the first argument, 
	since it implies that $x \odiv a \leq \bigvee X \odiv a$ for all $x \in X$.
	
	\begin{lemma}
		\label{distodiv}
		Let $\langle A, \leq, \monop, \odiv, \monid \rangle$ be an ReSL and $X \subseteq A$ a finite non-empty set. Then 
		\begin{itemize}
			\item $\forall a \in A.\, \bigvee \{ x \odiv a \mid x \in X \} \leq \bigvee X \odiv a$
		\end{itemize}	
	\end{lemma}
	
	
	%\begin{remark}
	Also this inequation holds for the empty set and for infinite sets, if the necessary LUBs exist.
	%
	Moreover, it also holds that $\bigvee \{ a \odiv x \mid x \in X \} \geq a \odiv \bigvee X$, since $\odiv$ is anti-monotone on the second argument.
	%\end{remark}
}

\comment{
	\begin{proposition}\label{reabs}
		Let $\langle A, \leq, \monop, \odiv, \monid \rangle$ be a residuated SLM. The following are equivalent
		\begin{enumerate}
			\item $\forall a \in A.\, a \leq \1$
			\item $\forall a \in A.\, \1 \odiv a = \1$		
			\item $\forall a, b \in A.\, a \leq b \implies b \odiv a = \1$
		\end{enumerate}	
	\end{proposition}
}

\comment{
	There are some important classes of residuated SLMs  such that $\odiv$ is easily proved to be distributive in the first argument,
	while it is not so with respect to the second one.
	%argument, not even in the absorptive case.
	
	\begin{lemma}
		\label{distodiv2}
		Let $\langle A, \leq, \monop, \odiv, \monid \rangle$ be a residuated SLM such that $\langle A, \leq \rangle$ is a total order and $X \subseteq A$ a finite non-empty set. Then 
		\begin{itemize}
			\item $\forall a \in A.\, \bigvee \{ x \odiv a \mid x \in X \} = \bigvee X \odiv a$
		\end{itemize}	
	\end{lemma}
	
	
	\begin{example}
		\label{nodist2}
		%Let $\langle A, \leq, \monop, \odiv, \monid \rangle$ be an ReSL such that $\langle A, \leq \rangle$ is a total order.
		%Then, it holds that $\bigvee \{ x \odiv a \mid x \in X \} = \bigvee X \odiv a$ for all elements $a$ and (non-empty finite) subsets $X$.
		%In fact, if $\langle A, \leq \rangle$ is a total order and $X$ is finite and non-empty we have that $\bigvee X \in X$, and since $\odiv$ 
		%is monotone on the first argument (see Lemma~\ref{mono}), the result follows.
		%
		Let $n$ be a positive integer and $[n] = \{0, \ldots, n\}$ the segment of integers from $0$ to $n$. We can now define the (bounded) monoid $\mathbb{M}_n$ 
		as the tuple $\langle [n], \geq, \oplus, \ominus, 0 \rangle$, where $\oplus$ and $\ominus$ are the bounded sum and subtraction, 
		which are given as $m\oplus p = min\{n, m+p\}$ and $m\ominus p = max\{0,m-p\}$.
		
		Now, it can be shown that $\mathbb{M}_n$ is an absorptive residuated SLM, and since it is a total order,
		$\ominus$ is  distributive on the first argument.
		%
		However, it is not distributive on the second one. Consider an integer $m$ such that 
		$m \neq n$ and the set $\{m, m+1\}$:
		we then have that $(m+1) \ominus \bigvee\{m, m+1\} = 1$,
		while instead $\bigvee\{(m+1) \ominus m, (m+1) \ominus (m+1)\} = 0$.
	\end{example}
	
	\begin{remark}
		Note that distributivity implies that $c \otimes (a \odiv b) = (c \otimes a) \odiv (c \otimes b)$,
		from which cancellativeness follows.
	\end{remark}
}

%\begin{remark}
%In general, given an ReSL $\mathbb{M} = \langle A, \leq, \otimes, \odiv, \monid \rangle$, if $A \subseteq B$ such that $B(\otimes)$ is a group and $\odiv$
% is the inverse of $\otimes$, then $\mathbb{M}$ is fully $%\odiv$-distributive, which follows from $\mathbb{M}$ is distributive for $\otimes$. \\
%Consider, for istance, $\mathbb{M} = \langle \{0,...,5\},\geq,\oplus,\ominus,0 \rangle$, where $\oplus$ and $\ominus$ are the bounded sum and subtraction (e.g. $2 \oplus 4 = 5$, $2 \ominus 4 = 0$): 
%it is clear that, in this case, distributivity holds for $\ominus$, as long as $a \geq b \implies b \ominus a = 0$. \\
%\todo{un esempio dove $\odiv$ non distribuisce}
%In the following example it is shown that distributivity for $\odiv$ could hold partially, since we choose a residuation operator which is not the inverse of $\otimes$.
%\end{remark}

%\begin{remark}\label{rmk:softUnit}
%The proposition above provides an important characterisation for all absorptive ReSLs, including all those mentioned in Remark~\ref{rmk:soft}.
%\end{remark}


\comment{
	\begin{example}
		Given $A = \{0,a,b,c,d,e\}$, consider the following partial order:
		\begin{center}
			\begin{tikzpicture}
			\node (top) at (0,0)  {$0$};
			\node (a) [below of= top] {$a$};
			\node [below left of=a] (left) {$b$};
			\node [below right of=a] (right) {$c$};
			\node (d) [below right of=left] {$d$};
			\node (e) [below of=d] {$e$};
			\draw [thick] (top) -- (a);
			\draw [thick] (a) -- (left);
			\draw [thick] (a) -- (right);
			\draw [thick] (left) -- (d);
			\draw [thick] (right) -- (d);
			\draw [thick] (d) -- (e);
			\end{tikzpicture}
		\end{center}
		and $\mathbb{M} = \langle A, \geq, \otimes, \odiv, 0 \rangle$, where $\otimes$ and $\odiv$ are defined as follows:
		\begin{center}
			\begin{tabular}{@{} *{7}{c} @{}}
				\\ $\otimes$ \ & 0 \ & a \ & b \ & c \ & d \ & e
				\\ 0 \ & 0 \ & a \ & b \ & c \ & d \ & e
				\\ a \ & a \ & b \ & c \ & d \ & e \ & f
				\\ b \ & b \ & c \ & d \ & d \ & e \ & e
				\\ c \ & c \ & d \ & d \ & d \ & e \ & e
				\\ d \ & d \ & e \ & e \ & e \ & e \ & e
				\\ e \ & e \ & e \ & e \ & e \ & e \ & e
			\end{tabular}
			\\	
			\begin{tabular}{@{} *{7}{c} @{}}
				\\ $\odiv$ \ & 0 \ & a \ & b \ & c \ & d \ & e
				\\ 0 \ & 0 \ & 0 \ & 0 \ & 0 \ & 0 \ & 0
				\\ a \ & a \ & 0 \ & 0 \ & 0 \ & 0 \ & 0
				\\ b \ & b \ & a \ & 0 \ & 0 \ & 0 \ & 0
				\\ c \ & c \ & a \ & 0 \ & 0 \ & 0 \ & 0
				\\ d \ & d \ & c \ & c \ & b \ & 0 \ & 0
				\\ e \ & e \ & d \ & b \ & c \ & a \ & 0
			\end{tabular}
		\end{center}
		Then $\mathbb{M}$ is an absorptive ReSL with $0$ the top of the partial order, since it behaves as the ReSL in the example above, except for $b$ and $c$: thus, in this case, $\bigvee \{b,c\} = a$. \\
		It's now easy to show that $\odiv$ is not distributive for the first argument: $\bigvee{b \odiv a, c \odiv a} = a$ and $\bigvee\{b,c\} \odiv a = a \odiv a = 0$.
	\end{example}
	
}

\comment{
	\subsection{On residuation and semirings}
	
	We now consider \emph{semirings} equipped with a partial order~\cite[Chapter~2]{golanShort}.
	
	\begin{definition}[semirings]
		A (commutative) semiring is a 5-tuple
		$\langle A, \monop, \monop, \monid, \1 \rangle$ such that $\langle A, \monop, \monid \rangle$
		and $\langle A, \monop, \1 \rangle$ are (commutative) monoids
		satisfying
		\begin{itemize}
			\item $\forall a \in A. a \monop \monid = \monid$
			\item $\forall a, b, c \in A. a \monop (b \monop c) = (a\monop b) \monop (a \monop c)$
		\end{itemize}
		An ordered semiring is a 6-tuple
		$\langle A, \leq, \monop, \monop, \monid, \1 \rangle$
		such that  $\langle A, \leq, \monop, \monid \rangle$ is an ordered monoid and 
		$\langle A, \monop, \monop, \monid, \1 \rangle$ a semiring satisfying
		\begin{itemize}
			\item $\forall a, b, c \in A. a \leq b \wedge \monid\leq c \implies c \monop a \leq c \monop b$
		\end{itemize}
	\end{definition}
	
	We often use an infix notation, as $a \monop b$ for $\monop(a,b)$.
	
	
	[A QUESTO PUNTO BISOGNA VEDERE QUALI DI QUESTE TRE PROPRIETA'
	DELL'ordered SEMIRING POSSONO DISCENDERE DA QUELLE DELLA RESIDUAZIONE,
	IN MODO DA AVERE GLI EQUIVALENTI DEI LEMMA 3 E 4]
	
	[ MA 1 MI SERVE A QUALCOSA?]
	
	\begin{definition}[residuation, II]
		A residuated semiring (ReS) is a 7-tuple $\langle A, \leq, \monop, \odiv, \monop, \monid, \1 \rangle$
		such that	$\langle A, \leq, \monop, \odiv, \monid \rangle$
		is a residuated monoid and $\langle A, \leq, \monop, \monop, \monid, \1 \rangle$ an ordered semiring,
		satisfying 
		\begin{itemize}
			????
		\end{itemize}
		A residuated SSL (ReSSL) is an ReS such that the underlying PO is a SL.
	\end{definition}
	
	[COSA PUO' SERVIRE COME ASSIOMA?]
	
	%In the following sections on oft CCP, we will often use absorptive RePOs, i.e., such that 
	%	\begin{itemize}
	%		\item[] $\forall a, \in A. a \leq 1$.
	%	\end{itemize}
	%
	%However, 
}

\comment{
	Indeed, there are many classes of absorptive and idempotent ReSLs such that $\odiv$ 
	is not distributive in either arguments.
	
	\begin{example}
		\label{notdistr}
		First of all, note that a complete sup-lattice $\langle A, \leq \langle$ (i.e., admitting a sup for all subsets 
		of $A$) can be turned into a ReSL. Indeed, $\otimes$ is just the meet, so we have that 
		
		\begin{itemize}
			\item $a \otimes b = \bigvee \{c \mid c \leq a \wedge c \leq b\}$
			\item $a \odiv b = \bigvee \{c \mid c \otimes b \leq a\}$
		\end{itemize}
		
		
		$$x \otimes y = \bigg \{\begin{array}{ll}
		\1 & \mbox{ if } y \leq x \\
		x & \mbox{ if } y = \1 \\
		\bot & \ otherwise
		\end{array}$$
		
		both meetand divis
		
		
		
		
		the bounded sum $\oplus$ is here idempotent, $0$ is still 
		the identity. We can make it int
		of three otherwise unrelated elements, 
		so that for all elements $x$ we have $x \otimes x = \1 \otimes x = x$ \
		and furthermore $a \otimes b = a \otimes c = b \otimes c  = \1$.
		
		We now add the bottom element $\bot$, in order to obtain a complete lattice.
		Then $\otimes$ is extended in the expected way, so that $\bot$ is absorbing.
		%
		The resulting semi-lattice monoid is absorptive and residuated, with $\odiv$ defined as
		
		$$x \odiv y = \bigg \{\begin{array}{ll}
		\1 & \mbox{ if } y \leq x \\
		x & \mbox{ if } y = \1 \\
		\bot & \ otherwise
		\end{array}$$
		%
		Thus, $\odiv$ does not distribute, since 
		$\bigvee \{a \odiv c, b \odiv c\}  = \bot < \1 = \1 \odiv c = \bigvee \{a, b\} \odiv c$.
	\end{example}
}

\comment{
	\begin{example}
		\label{notdistr}
		Let us consider the monoid $S = \langle \{p,u,n,t\}, \otimes_s, u \rangle$ (with $t$ the top 
		of three otherwise unrelated elements): 
		$p$ and $n$ intuitively represent the sign of an integer, $t$ tells us that 
		the sign cannot be determined, $u$ is the zero
		and $\otimes_s$ (which is idempotent) tells us the sign of the addition of two integers, so that 
		for all elements $x$ we have
		\[x \otimes_s x = u \otimes_s x = x \mbox{  and  } t \otimes_s x = p \otimes_s n = t\]
		%
		We now add the bottom, in order to obtain a complete lattice.
		The $\otimes_s$ is extended in the expected way,  so that $\bot$ is absorbing.
		%
		Intuitively, $\bot$ states that an element is unsigned:
		a pattern the reader familiar with abstract interpretation formalisms will recognise.
		
		The resulting semi-lattice monoid is residuated, with $\odiv$ defined as
		
		$$x \odiv y = \bigg \{\begin{array}{ll}
		t & y \leq x \\
		\bot & \ otherwise
		\end{array}$$
		%
		Thus, $\odiv$ does not distribute, since 
		$\bigvee \{p \odiv n, u \odiv n\}  = \bot < \bigvee \{p, u\} \odiv n = t \odiv n = t$.
	\end{example}
}

\section{A polyadic approach to constraint manipulation}\label{sec:newconstraint}

This section presents our personal take on polyadic algebras for ordered monoids:
the standard axiomatisation of e.g.~\cite{sagi2013} has been completely 
reworked, in order to be adapted to the constraints formalism.
%
It extends our previous description in~\cite{festcatuscia} by 
further elaborating on the laws for the polyadic operators in residuated monoids.

\subsection{Cylindric and Polyadic operators for Ordered Monoids}
\label{cypo}
We  introduce two families of operators 
%(cylindric and polyadic ones) 
that will be used
for modelling variables hiding and substitution, which represent
key features in languages for manipulating constraints.
%
One is a well-known abstraction for existential quantifiers,
the other an axiomatisation of the notion of
substitution, and it is proposed as a weaker  alternative 
to diagonals~\cite{popl91}, the standard tool for modelling 
equivalence in constraint programming.\footnote{``Weaker 
	alternative'' here means that diagonals allow for axiomatising
	substitutions at the expenses of working with complete
	partial orders: see e.g.~\cite[Definition 11]{jlamp17}.}
%

\comment{\smallskip
	Our first step is the introduction of a technical notion that allows for 
	factorising the common properties in the definition of the two families of operators.
	
	\begin{definition}[pomonoid action]
		\label{pomo}
		Let $\mathbb{M} = \langle A, \leq, \monop, \monid \rangle$ be a partially ordered monoid and $\mathbb{P} = \langle S, \leq \rangle$ a partial order.
		A pomonoid action of $\mathbb{M}$ on $\mathbb{P}$ is a function $\phi: A \times S \rightarrow S$ such that
		\begin{itemize}
			\item $\forall s \in S.\ \phi(\monid, s) = s$,
			\item $\forall a, b \in A,\ s \in S.\ \phi(a, \phi(b, s)) = \phi(a \otimes b, s)$,
			\item $\forall a, b \in A,\ s, t \in S.\ a \leq b\, \wedge\, s \leq t \implies \phi(a, s) 
			\leq \phi (b, t)$.
			% \item $\forall a, b \in A,\ s \in S.\ a \leq b \implies \phi(a, s) \leq \phi (b, s)$.
		\end{itemize}
	\end{definition}
	
	The first two requirements just state
	that $\phi$ is a monoid action of $\mathbb{M}$ on $S$, while the latter states that $\phi$ is monotone. Sometimes, we say that $\mathbb{P}$ is an $\mathbb{M}$-PO.}

\subsubsection{Cylindric operators.}
We fix a POM $\mathbb{S} = \langle A, \leq, \monop, \monid \rangle$
and a set $V$ of variables, and we define a family of cylindric operators axiomatising existential quantifiers.

\begin{definition}[Cylindrification]\label{cyli}
	A cylindric operator $\exists$ over $\mathbb{S}$ and $V$ is a family of monotone functions
	$\exists_x : A \rightarrow A$ indexed by elements in V such that for all 
	$a, b \in A$ and $x, y \in V$
	%\todo{$2_f^V$ non e' stato definito prima e/o f non si sa cosa e' qui}
	\begin{enumerate}
		\item $a \leq \exists_x a$,
		\item $\exists_x \exists_y a = \exists_y \exists_x a$,
		%\item $\forall a, b \in A.\ X \subseteq Y\wedge a \leq b \implies  \exists(X, a) = \exists(Y, b)$,
		%\item $\exists(X, \monid) = \monid$,
		\item $\exists_x (a \monop \exists_x b) = \exists_x a \monop \exists_x b$.
	\end{enumerate}
	
	\noindent Let $a \in A$. The \emph{support} of $a$ is the set of variables 
	$sv(a) = \{ x \mid \exists_x a \neq a\}$. 
	% and the set of unsupported variables of $a$ is the set of variables $uv(a) =  V \setminus sv(a)$.
\end{definition}

In other words, $\exists$ fixes a monoid action which is monotone and increasing.

%Note that, since by Definition~\ref{pomo} we have $\exists(\emptyset, a) = a$, the requirements of Definition~\ref{cyli} trivially hold 
%whenever $X$ is the empty set.
%
%The first two conditions tell us that $\exists$ is a monoid action of $M(V)$ over $A$. Condition $3$ states
%that $\exists$ is a monotone function. Finally, the last two conditions state how $\exists$ interacts with the 
%monoidal structure on $\mathbb{S}$.
%
%\begin{remark}
%TODO bisogna vedere cosa altro serve, e se qualche propriet\`a \`e derivata.
%Cosa succede se $\mathbb{S}$ \`e un SL? Questo impatta sui LUB in M(V)?
%\end{remark}
%
%
%Note also that $\exists(X, \monid) = \monid$ would be a consequence of monotonicity,
%should $\monid$ be the top element. Also, the support is not necessarily finite.
%Finally, and importantly, note that 
%$X \cap sv(\exists(X, a)) = \emptyset$.

%\smallskip
%In the following, we often use $\exists_X a$ for $\exists(X, a)$, and $\exists_x a$ whenever $X = \{x\}$.

\subsubsection{Polyadic operators.}
We now move to define a family of operators axiomatising substitutions.  
They interact with quantifiers, thus, beside a partially ordered monoid $\mathbb{S}$
and a set $V$ of variables, we fix a cylindric operator $\exists$ over ${\mathbb S}$ and $V$.

As for notation, $F(V)$ is the set of functions with domain and codomain $V$.
For a function $\sigma$ %: V \rightarrow V$ 
we define its support as $sv(\sigma) = \{x \mid \sigma(x) \neq x\}$
and, for a set $X \subseteq V$, we denote by 
$\sigma \mid_{X}: X \rightarrow V$ the restriction and
by $\sigma^{c}(X)$ the counter-image of $X$ along $\sigma$.
%~\footnote{We are not going to need the other standard component proposed in the literature , i.e., \emph{diagonals}: a %family of elements $d_{x, y} \in A$ indexed by pairs of elements in $V$.}


\begin{definition}[Polyadification]
	\label{def:poly}
	A polyadic operator $s$ for a cylindric operator $\exists$ is a family of monotone functions 
	$s_\sigma: A \rightarrow A$
	indexed by elements in $F(V)$ such that for all $a, b \in A$, $x \in V$, and $\sigma, \tau\in F(V)$
	\begin{enumerate}
		\item $sv(\sigma) \cap sv(a) = \emptyset \implies s_\sigma a = a$,
		\item $s_\sigma(a \monop b) = s_\sigma a \monop s_\sigma b$,
		\item $\sigma \mid_{sv(a)} = \tau \mid_{sv(a)} \implies s_\sigma a 
		= s_\tau a$,
		\item $\exists_x s_\sigma a = \begin{cases}
		s_\sigma \exists_y a &\text{if $\sigma^c(x) = \{y\}$}\\
		s_\sigma a &\text{if $\sigma^c(x) = \emptyset$}
		\end{cases}$.				
	\end{enumerate}
\end{definition}

%Clearly item $3$ always holds for an empty $X$.
%
A polyadic operator offers enough structure for modelling variable substitution. 
%
In the following, we fix a cylindric operator $\exists$
and a polyadic operator $s$ for it.

\comment{\begin{remark}
		The laws are directly adapted from~\cite{sagi2013}, with the exception of $2$, which 
		is stated as for a finite non-empty $X \subseteq V$ and $a \in A$
		\begin{itemize}
			\item[\emph{2'}.] $\sigma \mid_{V \setminus X} = \tau \mid_{V \setminus X}
			\implies \forall a\in A.\ s(\sigma, \exists (X, a)) = s(\tau, \exists (X, a))$.
		\end{itemize}
		However, the two formulations are equivalent. Indeed, note that
		$\sigma \mid_{V \setminus X} = \tau \mid_{V \setminus X}$ implies 
		$\sigma \mid_{sv(a) \setminus X} = \tau \mid_{sv(a) \setminus X}$, 
		which in turn implies that 
		$\sigma \mid_{\exists (X, a)} = \tau \mid_{\exists (X, a)}$, and 
		assuming item $2$ the result follows.
		%
		For the vice-versa, first of all note that 
		$\sigma \mid_{V \setminus X} = \tau \mid_{V \setminus X}$
		coincides with $\sigma \mid_{Y \setminus X} = \tau \mid_{Y \setminus X}$
		for $Y = sv(\sigma) \cup sv(\tau) \subseteq V$, and that $Y$ is finite
		since both $\sigma$ and $\tau$ are finitely supported.
		Now, $\sigma \mid_{sv(a)} = \tau \mid_{sv(a)}$ implies that 
		$\sigma \mid_{Y \setminus (Y \setminus sv(a))} = \tau \mid_{Y \setminus (Y \setminus sv(a))}$,
		thus by $2a$ we have 
		$s(\sigma, \exists (Y \setminus sv(a), a)) = s(\tau, \exists (Y \setminus sv(a), a))$.
		Since by definition we have $\exists (Y \setminus sv(a), a)) = a$, the result follows.
	\end{remark}
}

%\begin{remark}
%Note also that $\sigma(\sigma^{c}(X)) \subseteq X$, so, when restricted to singleton, we have that item %$3$ in Definition~\ref{def:poly} is equivalent to
%\begin{itemize}
%          \item[\emph{3'}.] $\forall a\in A.\ \sigma^{c}(x) = \{y\} \implies \exists_x s_{\sigma} a =  %s_\sigma \exists_y a$,
%          \item[\emph{3''}.] $\forall a\in A.\ \sigma^{c}(x) = \emptyset \implies \exists_x s_{\sigma} %a =  s_\sigma a$.
%\end{itemize}
%\end{remark}

%\noindent As we did for $\exists$, we define the support of $\sigma$ as follows:
%\begin{itemize}
%\item $sv(\sigma) = \bigcap X \subseteq V \mid \sigma(X) \neq X$
%\end{itemize}

\subsection{Cylindric and Polyadic operators for Residuated Monoids}
\label{cyre}
%Both algebraic structures introduced in the previous section are quite standard,
%even if polyadic operators are less-known in the soft-constraints literature:
%we tailored their presentation to our needs, and indeed the properties
%presented in Section~\ref{propo} appear to be original. 
We now consider 
the interaction of previous structures with residuation. 
%
To this end, in the following we assume that 
$\mathbb{S}$ is a residuated POM (see Def.~\ref{def:repo}).


\begin{lemma}
	\label{divex}
	Let $x \in V$ and $a, b \in A$.
	%$X \subseteq V$ be finite. 
	Then it holds
	%\begin{itemize}
	$\exists_x(a \odiv \exists_x b) \leq \exists_x a \odiv \exists_x b \leq
	\exists_x(\exists_x a \odiv b)$.
	%\end{itemize}
\end{lemma}



\begin{remark}
	\label{remdiv}
	It is clear that $\exists_x(a \odiv \exists_x b) \leq \exists_x a \odiv \exists_x b$
	is actually equivalent to state that
	$\exists_x(a \monop \exists_x b) \geq \exists_x a \monop \exists_x b$.
\end{remark}

We can show that $\odiv$ does not substantially alter the free variables of its arguments.

\begin{lemma}
	Let $a, b \in A$. Then it holds $sv(a \odiv b) \subseteq sv(a) \cup sv(b)$. 
\end{lemma}


%\begin{remark}
%\todo{un esempio dove $\odiv$ non distribuisce}
%\end{remark}

%Similarly, it is easy to show that it holds $\forall a, b \in A.\ \exists_x(\exists_x a \odiv b) \leq \exists_x a \odiv \exists_x b$. 
%

A result similar to Lemma~\ref{divex} relates residuation and polyadic operators.

%the following lemma holds.
%\todo{Mettere motivazione Lemma?}

\begin{lemma}
	Let $a, b \in A$ and $\sigma \in F(V)$. Then it holds
	%\begin{itemize}
	$s_\sigma (a \odiv b) \leq s_\sigma a \odiv s_\sigma b$.
	%\end{itemize}
	Furthermore, if $\sigma$ is invertible, then the equality holds.
	%\begin{itemize}
	%\item $\forall a,b \in A.\ s_\sigma (a \odiv b) = s_\sigma a \odiv s_\sigma b$.
	%\end{itemize}
\end{lemma}

\subsection{Polyadic Soft Constraints}\label{sec:softconstraints}
\label{subsec:inst} 
The key example of polyadic construction comes from soft constraints: 
our presentation generalises \cite{scc},
whose underlying algebraic structure is the one of absorptive semirings.

\begin{definition}[Soft constraints]\label{def:softconstraints}
	Let $V$ be a set of variables, $D$ a finite domain of interpretation
	and ${\mathbb S} = \langle A, \leq, \monop, \odiv, \monid \rangle$ a residuated SLM.
	A \emph{(soft) constraint} $c: (V \rightarrow D) \rightarrow
	A$ is a function associating a value in $A$ with each assignment
	$\eta: V\rightarrow D$ of the variables.
\end{definition}

The set of constraints forms a residuated SLM $\mathbb{C}$, with the structure
lifted from ${\mathbb S}$. Denoting the application of a
constraint function $c:(V \rightarrow D) \rightarrow A$ to a variable
assignment $\eta:V\rightarrow D$ as $c\eta$, we e.g. have that 
$c_1 \leq c_2$ if $c_1\eta\leq c_2\eta$ for all $\eta: V \rightarrow D$.

\begin{lemma}[Cylindric and polyadic operators for (soft) constraints]
	The residuated SLM of constraints $\mathbb{C}$ admits cylindric and polyadic operators, defined as
	\begin{itemize}
		\item  $(\exists_x c) \eta = \bigvee \{c \rho \mid \eta\mid_{V \setminus \{x\}} = 
		\rho\mid_{V \setminus \{x\}}\}$ for all $x \in V$,
		%\item if $\sigma$ is an injective substitution, then $(s_{\sigma}c)\eta = c(\sigma \circ \eta)$ 
		%for all $c \in \mathcal{C}$
		\item  $(s_\sigma c) \eta = c (\eta \circ \sigma)$ for all $\sigma \in F(V)$.
		%		\item $\delta_{x,y}\eta = \left\{
		%		\begin{array}{rcl} \bot & & \text{if } \eta(x) = \eta(y); \\
		%		\top & & \text{otherwise.}
		%		\end{array} \right.$ for all $x, y \in V$
	\end{itemize}
\end{lemma}

\begin{remark}
	Note that $sv(c)$ coincides with the classical notion of support
	for soft constraints. Indeed, if $x\not \in sv(c)$, then two
	assignments $\eta_1, \eta_2: V \rightarrow D$ differing only for the
	image of $x$ coincide (i.e., $c\eta_1 =
	c\eta_2$).
	%
	The cylindric operator is called \emph{projection} 
	in the soft framework, and $\exists_x c$ is denoted 
	$c\Downarrow_{V\setminus \{x\}}$.
\end{remark}

\comment{
	Combining constraints by the $\monop$ operator
	means building a new constraint whose support involves at most
	the variables of the original ones. The resulting constraint  associates with
	each tuple of domain values for such variables the element
	that is obtained by multiplying  those associated by the
	original constraints to the appropriate sub-tuples.
	%
	%Residuation works as expected (i.e., $(c_1\odiv c_2)\eta = c_1\eta\odiv c_2\eta$),
	%and 
	%Also, the bottom is the constant function mapping all $\eta$ to $\bot$.
	
	%\begin{example}[A simple CLIM]\label{execlim}
	%Let us consider a CLIM $\mathbb S$, 
	%and as $D$ a finite subset of the elements of the CLIM.
	%A polynomial with variables in $V$ 
	%and elements of the CLIM as coefficients
	%such as $ux \, \hat{+} \, vy \, \hat{+} \, z$
	%can be interpreted as the soft constraint associating 
	%with a function $\eta: V \rightarrow D$ the value 
	%$\bigvee \{u \monop \eta(x), v \monop \eta(y), z \}$.
	%The composition of such constraints is straightforward, while 
	%the ordering might not be the one induced by the coefficients, 
	%due to the presence of constants.
	%
	%More precisely, let us consider the CLIM of non-negative reals and
	%the polynomials $2x \, \hat{+} \, 1$ and $x \, \hat{+} \, 6$
	%and let us assume $D = \{1, 2, 3\}$.
	%The composition of such constraints is actually given just by coefficient 
	%addition, so that
	%$(2x \, \hat{+} \, 1) \monop (x \, \hat{+} \, 6) = 
	%(3x \, \hat{+} \, 7)$.
	%However, note that $2x \, \hat{+} \, 1 \leq x \, \hat{+} \, 6$.
	%
	%
	%Similarly for residuation, which is just bounded subtraction of coefficients.
	%Since $2x \, \hat{+} \, 1 \leq x \, \hat{+} \, 6$,
	%by construction ($2x \, \hat{+} \, 1) \odiv (x \, \hat{+} \, 6)$ is the bottom constraint,
	%mapping all variables to $0$.
	%Instead, $(x \, \hat{+} \, 6) \odiv (2x \, \hat{+} 1)$ could be described as $\hat{-}x \, \hat{+} \, 5$,
	%even if
	%the latter falls outside of the polynomials we considered since it has a negative coefficient:
	%it suffices to assume that if the actual result of the evaluation of the polynomial is negative 
	%then it is put to $0$.
	%
	%%
	%If $D$ is not the singleton, the support of a polynomial is precisely the set of variables occurring in it.
	%\end{example}
	
	%The ReSL of constraints also enjoys the cylindric properties, as shown by
	%the result below (for cylindric operators and diagonals in the idempotent case, see~\cite{scc}).
	
	\begin{lemma}[Cylindric and polyadic operators for (soft) constraints]
		The ReSL of constraints $\mathbb{C}$ admits cylindric and polyadic operators, defined as
		\begin{itemize}
			\item  $(\exists_x c) \eta = \bigvee \{c \rho \mid \eta\mid_{V \setminus \{x\}} = 
			\rho\mid_{V \setminus \{x\}}\}$ for all $c \in {\mathcal C}, x \in V$
			%\item if $\sigma$ is an injective substitution, then $(s_{\sigma}c)\eta = c(\sigma \circ \eta)$ 
			%for all $c \in \mathcal{C}$
			\item  $(s_\sigma c) \eta = c (\eta \circ \sigma)$ for all $c \in {\mathcal C}, \sigma \in F(V)$	
			%		\item $\delta_{x,y}\eta = \left\{
			%		\begin{array}{rcl} \bot & & \text{if } \eta(x) = \eta(y); \\
			%		\top & & \text{otherwise.}
			%		\end{array} \right.$ for all $x, y \in V$
		\end{itemize}
	\end{lemma}
	
	%In this section and in the following one, we denote by $\mathcal{C}$ the set of constraints that can be
	%built starting from chosen $\mathbb S$, $V$, and $D$. 
	
	A constraint involves all the variables in $V$, yet it may depend on
	the assignment of a finite subset of them, called its support. For
	instance, a binary constraint $c$ with $supp(c)=\{x,y\}$ is a function
	$c: (V\rightarrow D)\rightarrow A$ that depends only on the
	assignment of variables $\{x,y\}\subseteq V$, meaning that two
	assignments $\eta_1, \eta_2: V \rightarrow D$ differing only for the
	image of variables $z \not \in \{x,y\}$ coincide (i.e., $c\eta_1 =
	c\eta_2$).
	%
	%The support corresponds to the classical notion of scope of a
	%constraint.  We often refer to a constraint with support $X$ as $c_X$.
	%Moreover, an assignment over a support $X$ of cardinality $k$ is concisely
	%represented by a tuple $t$ in $D^k$, and we often write $c_X(t)$
	%instead of $c_X\eta$.
	
	
	Hiding means eliminating variables from the support:
	$supp(\exists_x c) \subseteq supp({c}) \setminus {x}$.\footnote{The operator
		is called \emph{projection} in the soft framework,
		and $\exists_x c$ is denoted $c\Downarrow_{V\setminus \{x\}}$.}
}

For the sake of simplicity, we will use running examples 
where 
%the SLM $\mathbb{S}$ is the semiring of integers and 
$D$ is a finite initial segment of the naturals. 
A constraint can be sometimes simply expressed as an inequation $x \leq 1$, 
intended as $c\eta = \monid$ if $\eta(x) \leq 1$, and $\bot$ otherwise.
%and we will exploit this fact.

\section{Polyadic Soft CCP: Syntax and reduction semantics}\label{sec:detpolyadicCCP}
This section introduces our language.
We fix a set of variables $V$, ranged over by $x$, $y$, $\ldots$, and 
a residuated POM $\mathbb S = \langle {\mathcal C}, \leq, \otimes, \odiv, \1\rangle$, 
which is cylindric and polyadic over $V$ and whose elements
are ranged over by $c$, $d$, $\ldots$

\begin{definition}[Agents]%
	The set $\mathcal{A}$ of agents, %which is
	parametric with respect to a set $\mathcal{P}$ of (unary) procedure declarations $p(x) = A$,
	is given by the following grammar
	\[ A \Coloneqq \: \: \mathit{\ostop} \mid \textit{\tell}(c)  \mid \textit{\ask}(c) \mapsto A \mid A \parallel A \mid %\exists_x A \mid %Z \mid \mu_Z A 
	p(x) \mid \exists_x A\]  
	%for $\pi \in {\mathcal C}^\ast$ a (possibly empty) sequence of elements.
\end{definition}

In the following we consider 
a set $\mathcal{E}$ of extended agents that uses the existential operator $\exists^{\pi}_x A$, 
where $\pi \in {\mathcal C}^\ast$ is meant to represent the sequence of updates performed on the local store. 
More precisely, the extended agent may carry some information about the hidden variable 
$x$ in an incremental way. We will often write $\exists_x A$ for $\exists^{[ \,]}_x A$ and $\pi_i$ for 
the $i$-th element of $\pi = [ \pi_0, \ldots, \pi_n]$.

We denote by $fv(A)$ the set of free variables of an (extended) agent, defined in the expected way 
by structural induction, assuming that $fv(\tell(c)) = sv(c)$,
$fv(\ask(c) \mapsto A) = sv(c) \cup fv(A)$,
% and We also remark that $fv(\exists_x A) = fv(A) \setminus \{x\}$ 
and $fv(\exists^{\pi}_x A) = (fv(A) \cup \bigcup_i sv(\pi_i)) \setminus \{x\}$.
%
In the following, we restrict our attention to 
procedure declarations $p(x) = A$ such that $fv(A) = \{x\}$.


\begin{definition}[Substitutions]
	Let $[^y/_x]: V \to V$ be the substitution defined as
	\[ [^y/_x](w) = 
	\begin{cases} 
	y & \text{if $w = x$} \\
	w & \text{otherwise}
	\end{cases}. \]
	
	It induces an operator $[^y/_x]: \mathcal{E} \rarrow \mathcal{E}$ on extended agents as expected,  in particular
	
	%\begin{itemize}
	%	\item $\ostop[^y/_x] = \ostop$
	%	\item $\tell(c)[^y/_x] = \tell(s_{[^y/_x]}c)$
	%	\item $(\ask(c) \rightarrow A)[^y/_x] = \ask(s_{[^y/_x]}(c)) \rightarrow A[^y/_x]$
	%\item $[^y/_x] (\exists_w A)  = \exists_w ([^y/_x] A) \ \ \text{for $w \not \in \{x, y\}$}$
	%	\item $p(w)[^y/_x] =  p([^y/_x](w))$
	%	\item $(A_1 \parallel A_2)[^y/_x]  = (A_1[^y/_x] \parallel A_2[^y/_x])$
	$$(\exists^{\pi}_w A)[^y/_x] = \begin{cases} 
	\exists^{(s_{[^y/_x]} \pi)}_w A[^y/_x]  & \text{if } w \not \in \{x, y\} \\
	(\exists^{(s_{[^z/_w]} \pi)}_z A[^z/_w])[^y/_x] & \text{for } z \not \in fv(\exists^{\pi}_w A) \text{ otherwise}
	\end{cases}$$
	%\end{itemize}
	with $s_{[^y/_x]} [ \pi_1, \ldots, \pi_n ]$ a shorthand for $[s_{[^y/_x]} \pi_1, \ldots, s_{[^y/_x]} \pi_n]$.
\end{definition}

Note that the choice of $z$ in the rule above is immaterial, since for the polyadic operator it holds
$\exists_x c = \exists_y s_{[^y/_x]}(c)$ if $y \not \in sv(c)$.
%
In the following we consider terms to be equivalent up-to $\alpha$-conversion, meaning that terms 
differing only for hidden variables are considered equivalent, i.e.,
$\exists_w^\pi A = \exists_z^{(s_{[^z/_w]}\pi)} A[^z/_w]$ for $z \not \in fv(\exists^{\pi}_w A)$.

\begin{lemma}
	Let $A \in \mathcal{E}$ and $x \not \in fv(A)$. Then $A[^y/_x] = A$.
	%\todo{Gi\`a dimostrato}
\end{lemma}


\subsection{Reduction semantics}
We now move to the reduction semantics of our calculus. 
%
Given a sequence $\pi = [\pi_1, \ldots,$ $\pi_n]$, we will use 
$\pi_\otimes$ and $\exists_x \pi$
as shorthands for $\pi_1 \otimes \ldots \otimes \pi_n$ and
$[\exists_x \pi_1, \ldots, \exists_x \pi_n]$, respectively,
sometimes combining them as in $(\exists_x \pi)_\otimes$,
with $[\,]_\otimes = \1$.

\begin{definition}[Reductions]\label{def:reductions}
	Let $\Gamma = {\mathcal E} \times \C$ be the set of \emph{configurations}.
	The \emph{direct reduction semantics} for SCCP is the pair 
	$\langle \Gamma,  \to \rangle$
	such that $\to \, \, \subseteq \, \,\Gamma \times   \Gamma$ is the 
	binary relations obtained by the rules in 
	Table~\ref{fig:operational}.
	
	The \emph{reduction semantics} for SCCP is the pair 
	$\langle \Gamma,  \rightarrow \rangle$
	such that $\rightarrow \, \, \subseteq \, \,\Gamma \times   \Gamma$ is the
	binary relation obtained by the rules in 
	Table~\ref{fig:operational} and Table~\ref{fig:operational2}.
\end{definition}

%\vspace{-.25cm}
%\def\odiv{\; {\ominus\hspace{-6pt} \div} \;}
%\def\odivvv{\; {\ominus\hspace{-6pt} \div} \;}

\begin{table}[t]  %\hfil5
	%\scalebox{0.9}{
	\begin{center}
		\begin{tabular}{lcll} 
			%
			\mbox{\bf A1}& $ {\displaystyle \langle \hbox{\tell}(c), \sigma \rangle \to \langle 
				\hbox{\ostop}, \sigma \otimes c\rangle}$
			\ \ \ & \bf{Tell}&
			\\ 
			&\mbox{   }&\mbox{   } &\mbox{   }
			\\
			\mbox{\bf A2}& $\frac {\displaystyle \sigma \leq c}{\displaystyle
				\begin{array}{l} \langle \hbox{\ask}(c) \mapsto A, \sigma \rangle \to \langle A, \sigma \rangle   	\end{array}}$
			\ \ \ & \bf{Ask}&
			\\
			&\mbox{   }&\mbox{   }&
			\\
			\mbox{\bf A3}& $\frac {\displaystyle p(x) = A \in \mathcal{P} }
			{\displaystyle\langle p(y),\sigma\rangle \to \langle A[^y/_x], \sigma \rangle}$ 
			&\bf{Rec}&
			%\\
			%&\mbox{   }&\mbox{   }&
			%\\
			%\mbox{\bf A4}& $\frac {\displaystyle sv(\sigma) \cup fv(\exists_x A) \subseteq 
			%\Delta \wedge w \not \in \Delta }
			%{\displaystyle\langle \exists_x A,\sigma\rangle \to_\Delta \langle [^w/_x]A,
			%\sigma\rangle}$
			%&\bf{Hide}&
			%\\
			%&\mbox{   }&\mbox{   }&
		\end{tabular}
	\end{center}
	\caption{Axioms of the reduction semantics for SCCP.}
	\label{fig:operational}
\end{table}

\begin{table}  %\hfil5
	%\scalebox{0.9}{
	\begin{center}
		\begin{tabular}{lcll} 
			%
			\mbox{\bf R1}& $\frac {\displaystyle \langle A, \sigma\rangle \to \langle A', \sigma' \rangle} 
			{\displaystyle \begin{array}{l}
				\langle A\parallel B, \sigma \rangle \to \langle A'\parallel B, \sigma' \rangle
				\end{array}}$ 
			& \bf{Par1}&
			\\
			& \mbox{   }&\mbox{   }&
			\\
			\mbox{\bf R2}& $\frac {\displaystyle \langle A, \pi_0 \otimes \sigma \rangle
				\to \langle B, \sigma_1 \rangle \text{ with } \pi_0 = \pi_\otimes \odiv (\exists_x \pi)_\otimes}
			{\displaystyle\langle \exists^{\pi}_x A,\sigma\rangle \to \langle 
				\exists^{\pi \rho}_x B, \sigma \otimes \exists_x \rho
				\rangle \text{ with } \rho = \sigma_1 \odiv (\pi_0 \otimes \sigma)} \text{ for } x \not \in sv(\sigma)$
			&\bf{Hide}&
		\end{tabular}
	\end{center}
	\caption{Contextual rules of the reduction semantics for SCCP.}
	\label{fig:operational2}
\end{table}

The split distinguishes between the axioms and the rules guaranteeing the closure with respect to the parallel and existential operators. Indeed, rule {\bf  R1} models the interleaving of two agents in parallel, assuming for the sake of simplicity
that the parallel operator is associative and commutative, as well as satisfying $ \hbox{\ostop} \parallel A = A$.
%
%
In {\bf A1} a constraint $c$ is added to the store $\sigma$.
%, which in the next step will be $\sigma \otimes c$.
%
{\bf A2} checks if $c$ is entailed by  $\sigma$: if not, the computation is blocked.
%
Axiom {\bf A3} replaces a procedure identifier with the associated body, renaming the formal parameter with the actual one.
%$A[^y/_x]$ stands for the agent obtained by replacing all the occurrences of $x$ with $y$.
%
%Axiom {\bf A4} hides the variable $x$ occurring in $A$, replacing it  
%with a globally fresh variable,
%as ensured by $w \not \in \Delta$.
%The latter is more general than just requiring that 
%$w \not \in fv(\exists_x A) \cup sv(\sigma)$, since
%$\langle B, \rho \rangle   \rarrow_\Delta$ implies that 
%$fv(B) \cup sv(\rho) \subseteq \Delta$.\footnote{Our rule is  reminiscent of 
%$(8)$ in~\cite[p.~342]{popl91}.}

Let us instead discuss in some details the rule {\bf R2}.
The intuition is that if we reach an agent $\langle \exists^{\pi}_x A,\sigma\rangle$, then during the computation
a sequence $\pi$ of updates has been performed by the local agent and $(\exists_x \pi)_\otimes$ 
has been added to the global store. In order to evaluate $A$, the chosen 
store is 
$\pi_0 \otimes \sigma$ for $\pi_0 = \pi_\otimes \odiv (\exists_x \pi)_\otimes$: the
effect $(\exists_x \pi)_\otimes$ of the sequence of updates is removed from the local store $\pi_\otimes$,
which may carry information about $x$, since that effect had been previously added to the global store.
%
Now, $\rho = \sigma_1 \odiv (\pi_0 \otimes \sigma)$ 
is precisely the information added by the step originating from $A$, which is then restricted and added to $\sigma$. 
On the local store we simply add that effect $\rho$ to the sequence of updates, with
$\pi \rho = [\pi_0, \ldots, \pi_n, \rho]$.

\begin{lemma}[On monotonicity]
	\label{rmono}
	Let $\langle A, \sigma \rangle \rightarrow \langle B, \rho \rangle$ be a reduction. 
	Then $\rho = (\rho \odiv \sigma) \otimes \sigma$ and $fv(\langle B, \rho \rangle) \subseteq fv(\langle A, \sigma \rangle)$.
	%\begin{enumerate}
	%\item $\exists \sigma''.\  \sigma' = \sigma'' \otimes \sigma$
	%\item $fv(\langle B, \sigma' \rangle) \subseteq fv(\langle A, \sigma \rangle)$
	%\end{enumerate}
\end{lemma}

%By the properties of residuation, a witness of the equality in item $1$ is
%$\sigma' \odiv \sigma$.


\comment{
	\begin{remark}
		%\todo{TO BE REDONE}
		%The choice for the resulting global store in rule {\bf R2} could have been 
		%$\sigma_0 \otimes \exists_x(\sigma_1 \odiv \sigma _0)$, 
		%Indeed, the expression has a nicer appearance,
		%and $\sigma_1 \odiv \sigma_0$ seems to better represent the cumulative effect of the
		%changes by the local agent.
		%However, this is a misleading impression, since the composition of the single updates
		%has to take into account the existential quantifications.
		
		The choice of labelling $\exists_x^\pi$ with a string of updates instead of just an element 
		can then be explained by the need to distinguish their effect on the local and the global stores.
		%
		Let us consider constraints $c$ and $d$ such that $\exists_x c = \exists_x d = \monid$ and $c \otimes d = \bot$.
		As far as our running example is concerned, it might be that $c = x \leq 1$ and $d = x \geq 5$.
		Let $A$ be the agent $\hbox{\tell}(c) \parallel \hbox{\tell}(d) \parallel B$ and $\gamma$ the configuration 
		$\langle \exists_x A, \monid \rangle$.
		If first $c$ and then $d$ are added to the store, we would end up with the reductions
		$\gamma \to \langle \exists_x^{[ c ]} \hbox{\tell}(d) \parallel B, \monid \rangle 
		\to \langle \exists_x^{[c,\bot \apexodiv c]} B, \exists_x (\bot \odiv c) \rangle$
		and 
		$\gamma \to \langle \exists_x^{ c } \hbox{\tell}(d) \parallel B, \monid \rangle 
		\to \langle \exists_x^{ \bot } B, \exists_x (\bot \odiv c) \rangle$.
		%
		Let us further assume that $\exists_x (\bot \odiv c) = \monid$, as it occurs in our example.
		Then, for any possibile move of $B$ we have that 
		$\langle \exists_x^{ \bot } B, \exists_x (\bot \odiv c) \rangle
		\to \langle \exists_x^{ \bot } C, \exists_x \top \rangle$.
		
		
		
		With the alternative definition for the global store, we would then reach 
		$\langle \exists_x^{[c]} \hbox{\tell}(d), \monid \rangle \to \langle \exists_x^{[c,\bot \apexodiv c]} \hbox{\ostop}, \bot \rangle$,
		thus lifting to the global store the unsatisfiability of the local one.
		Instead, with our choice we obtain 
		$\langle \exists_x^{[c]} \hbox{\tell}(d), \monid \rangle \to \langle \exists_x^{[c,\bot \apexodiv c]} \hbox{\ostop}, \exists_x (\bot \odiv c) \rangle$, 
		% since $\sigma \otimes \exists_x(\sigma_1 \odiv (\rho \otimes \sigma _0)) 
		%= \monid \otimes \exists_x ( \bot \odiv (c \otimes \monid))$.
		Now, obviously $\bot \leq \bot \odiv c$: the equality may hold if e.g. the semiring does not have zero divisors, 
		but this is not the case, since we assumed $c \otimes d = \bot$.
		Going back to our running example, with $c = x \leq 1$ we have $\bot \odiv c = \emptyset \odiv x \leq 1 = x > 1$
		and thus $\exists_x (\bot \odiv c) = \monid$.
		
		Note also how the sequence in the local store is $[c,\bot \odiv c]$: $\bot \odiv c$ does not necessarily coincide with $d$.
		However, it is the minimal information collapsing the local store, and since the semiring is not 
		necessarily invertible, it is often the best result we can get.
	\end{remark}
}

\begin{remark}
	\label{crisp}
	With respect to the crisp language with local variables introduced in \cite{pippo},
	which can be recasted in our framework as absorptive POMs
	where the monoidal operator is idempotent,
	our proposal differ mostly for the the structure of rule \mbox{\bf R2}, which could 
	be presented as below
	$$\frac {\displaystyle \langle A, \pi_0 \otimes \sigma \rangle
		\to \langle B, \xi \otimes \pi_0 \otimes \sigma \rangle \text{ with } \pi_0 = \pi_\otimes \odiv (\exists_x \pi)_\otimes}
	{\displaystyle\langle \exists^{\pi}_x A,\sigma\rangle \to \langle 
		\exists^{\pi \xi}_x B, \sigma \otimes \exists_x \xi
		\rangle} \text{ for } x \not \in sv(\sigma)$$
	The proposals coincide for e.g. cancellative monoids, since inverses are unique.
	However, this is not so if the monoidal operator is idempotent, thus 
	the crisp rule represents in fact a schema, giving rise to a possibly infinite
	family of reductions departing from an agent. Our choice of a chosen witness 
	$\exists_x \sigma_1 \odiv (\pi_0 \otimes \sigma)$ avoids such non-determinism.
\end{remark}

Let $\gamma = \langle A, \sigma \rangle$ be a configuration.
%
We denote by $fv(\gamma)$ the set $fv(A) \cup sv(\sigma)$ and by
$\gamma[^z/_w]$ the component-wise application of the substitution $[^z/_w]$.

\begin{definition}
	A configuration $\langle A, \sigma \rangle$ is initial if $A\in \mathcal{A}$
	and $\sigma = \1$; it is reachable if it can be reached by an initial configuration 
	via a sequence of reductions.
\end{definition}

\begin{lemma}[On monotonicity, II]
	\label{mono2}
	Let $\langle A \parallel \exists_x^\pi B, \sigma \rangle$ 
	be a reachable configuration.
	Then $\sigma = (\sigma \odiv (\exists_x \pi)_\otimes) \otimes (\exists_x \pi)_\otimes$.
	%\begin{enumerate}
	%\item $\exists \sigma'.\  \sigma = \sigma' \otimes (\exists_x \pi)_\otimes$
	%\end{enumerate}
\end{lemma}

\begin{remark}
	An alternative solution for the the structure of rule \mbox{\bf R2} would have been
	$$\frac {\displaystyle \langle A, \pi_\otimes \otimes \sigma_0 \rangle
		\to \langle B, \sigma_1 \rangle \text{ with } \sigma_0 = \sigma \odiv (\exists_x \pi)_\otimes}
	{\displaystyle\langle \exists^{\pi}_x A,\sigma\rangle \to \langle 
		\exists^{\pi \rho}_x B, \sigma \otimes \exists_x \rho
		\rangle \text{ with } \rho = \sigma_1 \odiv (\pi_\otimes \otimes \sigma_0)} \text{ for } x \not \in sv(\sigma)$$
	Indeed, in the light of Lemma~\ref{mono2}, the proposals coincide for 
	invertible semirings, since 
	$\pi_0 \otimes \sigma
	=
	(\pi_\otimes \odiv (\exists_x \pi)_\otimes) \otimes (\exists_x \pi)_\otimes \otimes (\sigma \odiv (\exists_x \pi)_\otimes)
	\leq
	\pi_\otimes \otimes (\sigma \odiv (\exists_x \pi)_\otimes)$,
	and the equality holds for invertible semirings
	since $\pi_\otimes \leq (\exists_x \pi)_\otimes$.
\end{remark}


%As before, a witness of the equality in item $1$ is
%$\sigma \odiv (\exists_x \pi)_\otimes$.


\subsection{Saturated bisimulation}\label{sec:saturated}
As proposed in \cite{pippo} for crisp languages, we define a barbed equivalence between two agents~\cite{barbed}.  
%
Intuitively, barbs are basic observations (predicates) on the states of a system, and in our case they correspond 
to the constraints in $\mathcal{C}$.

\begin{definition} [Barbs]
	Let $\langle A, \sigma \rangle$ be a configuration and $c \in \mathcal{C}$. We say that $\langle A, \sigma \rangle$ verifies $c$, or that $\langle A, \sigma \rangle \downarrow_c$ holds, if  $\sigma \leq c$.
\end{definition}

In other terms, satisfying a barb $c$ means that $\hbox{\ask}(c)$ must be enabled in $\langle A, \sigma \rangle$.
%
We now move to consider equivalence and, %Since \emph{barbed bisimilarity} is an equivalence already for CCP, 
along~\cite{pippo}
we propose the use of \emph{saturated bisimilarity}
%~\cite{barbedMontanari} has been proposed 
in order to obtain a congruence.
%
%Definition~\ref{def:strongsb} and Definition~\ref{def:weaksb} respectively provide the strong and weak definition of saturated bisimilarity.
%We say that $\gamma = \langle P, \sigma\rangle$ satisfies the barb $c$, written $\gamma \downarrow_c$,
%iff $\gamma \longrightarrow \gamma'$ and $\gamma' \downarrow_c$.
%\marginpar{Are barbs compact?}

\begin{definition}[Saturated bisimilarity]\label{def:strongsb} A saturated bisimulation is a symmetric relation $R$ on configurations such that whenever
	%$(\gamma_1,\gamma_2) \in R$ with $\gamma_1 = \langle A, \sigma \rangle$
	%and $\gamma_2 = \langle B, \rho \rangle$
	$( \langle A, \sigma \rangle,\langle B, \rho \rangle) \in R$
	\begin{enumerate}
		\item if $\langle A, \sigma \rangle \downarrow_c$ then $\langle B, \rho \rangle \downarrow_c$;
		\item if $\langle A, \sigma \rangle \to \gamma_1$ then there is $\gamma_2$ such that $\langle B, \rho \rangle \to \gamma_2$ and $(\gamma_1, \gamma_2) \in R$;
		\item $(\langle A,\sigma \otimes d\rangle, \langle B,\rho \otimes d \rangle) \in R$ for  all $d$.
	\end{enumerate}
	We say that $\gamma_1$ and $\gamma_2$ are  saturated bisimilar ($\gamma_1  \sim_{\mathit{s}} \gamma_2$) if there exists a  saturated  bisimulation $R$ such that $(\gamma_1 , \gamma_2 ) \in R$. We write $A \sim_{\mathit{s}} B$ if $\langle A, \monid \rangle \sim_{\mathit{s}} \langle B, \monid \rangle$.
\end{definition}

Note that $\langle A, \sigma \rangle \sim_{\mathit{s}} \langle B, \rho \rangle$ implies
that $\sigma = \rho$.
\comment{
	This fact does not hold if we move to weak relations. To this end, 
	we let $\rightarrow$ denote the reflexive and transitive closure of $\to$.
	
	\begin{definition} [Weak barbs]
		Let $\langle A, \sigma \rangle$ be a configuration and $c \in \mathcal{C}$.
		We say that $\langle A, \sigma \rangle$ weakly verifies $c$, or that $\langle A, \sigma \rangle \Downarrow_c$ holds, 
		if  there exists $\gamma' = \langle B, \rho \rangle$ such that 
		$\gamma \Rightarrow \gamma'$ and $\rho \leq c$.
	\end{definition}
	
	\begin{definition}[Weak saturated bisimilarity]\label{def:weaksb} A weak saturated bisimulation is a symmetric relation $R$ on configurations such that whenever
		%$(\gamma_1,\gamma_2) \in R$ with $\gamma_1 = \langle A, \sigma \rangle$
		%and $\gamma_2 = \langle B, \rho \rangle$
		$( \langle A, \sigma \rangle,\langle B, \rho \rangle) \in R$
		\begin{enumerate}
			\item if $\langle A, \sigma \rangle \downarrow_c$ then $\langle B, \rho \rangle \Downarrow_c$;
			\item if $\langle A, \sigma \rangle \to \gamma_1$ then there is $\gamma_2$ such that $\langle B, \rho \rangle \Rightarrow \gamma_2$ and $(\gamma_1, \gamma_2) \in R$;
			\item $(\langle A,\sigma \otimes d\rangle, \langle B,\rho \otimes d \rangle) \in R$ for all $d \in \mathcal{C}$.
		\end{enumerate}
		We say that $\gamma_1$ and $\gamma_2$ are  weakly saturated bisimilar ($\gamma_1  \approx_{\mathit{s}} \gamma_2$) if there exists a  
		weak saturated  bisimulation $R$ such that $(\gamma_1 , \gamma_2 ) \in R$. 
		We write $A \approx_{\mathit{s}} B$ if $\langle A, \monid \rangle \approx_{\mathit{s}} \langle B, \monid \rangle$.
	\end{definition}
	
	The asymmetry is functional to later sections. However, it is clearly equivalent to the standard symmetric version.
	
	\begin{lemma}[Weak saturated bisimilarity, 2]\label{def:weaksb2}
		Weak saturated bisimilarity coincides with the relation 
		obtained from Definition~\ref{def:strongsb} by replacing $\to$ with $\Rightarrow$ and $\downarrow_c$ with $\Downarrow_c$.
	\end{lemma}
	
	
	Since $\sim_{\mathit{s}}$ and $\approx_{\mathit{s}}$ are saturated bisimulations, they are clearly upward closed 
	and they are also congruences. Indeed, a context $C[\cdot]$, i.e., an (extended) agent with an placeholder $\cdot$,
	can modify the behaviour of a configuration only by adding constraints to its store. 
}
%Since $\sim_{\mathit{s}}$ is a saturated bisimulation, it is clearly closed with respect
%to the addition of constraints to a store. 
Moreover, it is also a congruence. Indeed, a context $C[\cdot]$, i.e., an agent with an placeholder $\cdot$,
can modify the behaviour of a configuration only by adding constraints to its store. 

\begin{proposition}
	\label{cong1}
	Let $A \sim_{\mathit{s}} B$ and $C[\cdot]$ a context.
	Then $C[A] \sim_{\mathit{s}} C[B]$.
\end{proposition}



\section{Labelled reduction semantics}\label{sec:labelled}
The definition of $\sim_{\mathit{s}}$ 
%and $\approx_{\mathit{s}}$ are fully abstract, they are somewhat 
is unsatisfactory
because of the store closure, i.e., the quantification in condition \emph{3} of 
Definiton~\ref{def:strongsb}.
% and Definition~\ref{def:weaksb}.
This section presents a labelled version of the reduction semantics that 
allow to partially 
%will be used to 
%define a suitable bisimulation that 
avoid such drawback.

\begin{definition}[Labelled reductions]
	Let $\Gamma = {\mathcal A} \times \C$ be the set of \emph{configurations}.
	The  \emph{labelled direct reduction semantics} for SCCP is the pair 
	$\langle \Gamma,   \xrightarrow{ }  \rangle$
	such that $\to \, \, \subseteq \, \,\Gamma \times \mathcal{C} \times \Gamma$ is the ternary
	relation obtained by the rules in Table~\ref{fig:ALTS}.
	
	The \emph{labelled reduction semantics} for SCCP is the pair 
	$\langle \Gamma,  \rightarrow \rangle$
	such that $\rarrow \, \, \subseteq \, \,\Gamma \times \mathcal{C} \times  \Gamma$ is the ternary relation
	obtained by the rules in Table~\ref{fig:ALTS} and Table~\ref{fig:CRLTS}.
\end{definition}


\begin{table}  %\hfil5
	\begin{center}
		\scalebox{0.9}{
			\begin{tabular}{lcll} 
				%
				\mbox{\bf LA1}& ${\displaystyle \langle \hbox{\tell}(c), \sigma \rangle \xrightarrow{\monid} 
					\langle \hbox{\ostop}, \sigma \otimes c\rangle}$
				\ \ \ & \bf{Tell}&
				\\ 
				&\mbox{   }&\mbox{   } &\mbox{   }
				\\
				\mbox{\bf LA2}& $\frac{\displaystyle \alpha \leq  c  \odiv  \sigma} %\wedge \alpha \leq \1} 
				{{\displaystyle
						\begin{array}{l} \langle \hbox{\ask}(c) \mapsto A, \sigma \rangle \xrightarrow{\alpha}
						\langle A, \alpha \otimes \sigma \rangle
						\end{array}}}$
				\ \ \ & \bf{Ask}&
				\\
				&\mbox{   }&\mbox{   }&
				\\
				\mbox{\bf LA3}& $\frac {\displaystyle p(x) = A \in  \mathcal{P} }
				{\displaystyle\langle p(y),\sigma\rangle \xrightarrow{\monid} \langle  A[^y/_x], \sigma\rangle}$ 
				&\bf{Rec}&
			\end{tabular}
		}
	\end{center}
	\caption{Axioms of the labelled semantics for \SCCP.}
	\label{fig:ALTS}
\end{table}



\def\oodiv{\; {\ominus\hspace{-7.5pt} \div} \;}

\begin{table}  %\hfil5
	\begin{center}
		\scalebox{0.85}{
			\begin{tabular}{lcll} 
				%
				\mbox{\bf LR1}& $\frac {\displaystyle \langle A,\sigma \rangle \xrightarrow{\alpha} \langle A', \sigma' \rangle} 
				{\displaystyle \begin{array}{l}
					\langle A\parallel B, \sigma \rangle \xrightarrow{\alpha} \langle A'\parallel B, \sigma' \rangle
					\end{array}}$ 
				& \bf{Par}&
				\\
				& \mbox{   }&\mbox{   }& \mbox{   }
				\\
				\mbox{\bf LR2} & $\frac {\displaystyle \langle A, \pi_0 \otimes \sigma \rangle \xrightarrow{\alpha}
					\langle B, \sigma_1 \rangle \text{ with } \pi_0 = \pi_\otimes \oodiv (\exists_x \pi)_\otimes }
				{\displaystyle \langle \exists^\pi_x A, \sigma \rangle \xrightarrow{\alpha}
					\langle \exists^{\pi \rho}_x B, \alpha \otimes \sigma \otimes \exists_x \rho \rangle  \text{ with } \rho = \sigma_1 \oodiv (\alpha \otimes \pi_0 \otimes \sigma)}
				\text{ for } x \not \in sv(\sigma) \cup sv(\alpha)$
				&\bf{Hide}&
			\end{tabular}
		}
	\end{center}
	\caption{Contextual rules of the labelled semantics for \SCCP.}
	\label{fig:CRLTS}
\end{table}

%The split distinguishes between the axioms and the rules guaranteeing the closure with respect to the parallel and 
%existential operators. Indeed, rules {\bf  R1} models the interleaving of two agents in parallel, assuming for the sake of 
%simplicity that the parallel operator is associative and commutative, as well as $ \hbox{\ostop} \parallel A = A$.
%%
%%
%In {\bf A1} a constraint $c$ is added to the store $\sigma$.
%%, which in the next step will be $\sigma \otimes c$.
%%
%{\bf A2} checks if $c$ is entailed by  $\sigma$: if not, the computation is blocked.
%%
%Axiom {\bf A3} replaces a procedure identifier with the associated body, renaming the formal parameter with the actual one.
%%$A[^y/_x]$ stands for the agent obtained by replacing all the occurrences of $x$ with $y$.
%%
%%Axiom {\bf A4} hides the variable $x$ occurring in $A$, replacing it  
%%with a globally fresh variable,
%%as ensured by $w \not \in \Delta$.
%%The latter is more general than just requiring that 
%%$w \not \in fv(\exists_x A) \cup sv(\sigma)$, since
%%$\langle B, \rho \rangle   \rarrow_\Delta$ implies that 
%%$fv(B) \cup sv(\rho) \subseteq \Delta$.\footnote{Our rule is  reminiscent of 
%%$(8)$ in~\cite[p.~342]{popl91}.}

In Table~\ref{fig:ALTS} and Table~\ref{fig:CRLTS} we refine the notion of transition (respectively given in Table~\ref{fig:operational} and Table~\ref{fig:operational2})
by adding a label that carries additional information about the constraints that cause the reduction.
Indeed, rules in Table~\ref{fig:ALTS} and Table~\ref{fig:CRLTS} mimic those in Table~\ref{fig:operational} and Table~\ref{fig:operational2}, except for a constraint $\alpha$ that
represents the additional information that must be combined with $\sigma$ in order to fire an action
from $\langle A, \sigma\rangle$  to $\langle A', \sigma' \rangle$.
% i.e., $\langle A, \sigma \otimes \alpha\rangle \longrightarrow \langle A' , \sigma' \rangle$.

For the rules in Table~\ref{fig:ALTS}, as well as for rule {\bf  LR1}, we can restate the intuition given for their unlabelled counterparts. 
The difference concerns the axioms for the $\hbox{\ask}(c)$: if $c$ is not entailed from $\sigma$, then
some additional information  is imported from the environment, ensuring that the state
$\alpha \otimes \sigma \leq c$ allows the execution of $\hbox{\ask}(c)$.
\comment{The requirement $\alpha \leq \1$ ensures that the received information strengthens the store, 
	i.e., $\alpha \otimes \sigma \leq \sigma$.
	\todo{$\alpha \leq \1$ si pu\`o rimuovere}}
%in order not to put forward future requests, as it might be otherwise needed for e.g. 
%$\hbox{\ask}(c) \to \hbox{\ask}(c) \to \hbox{\ostop}$.

Once again, the more complex axiom is {\bf LR2}. With respect to {\bf R2}, the additional intuition is that 
$\alpha$ should not contain the restricted variable $x$: additional information can be obtained from the environment,
as long as it does not interact with data that are private to the local agent.
%
Note that by choosing $\rho = \sigma_1 \odiv (\alpha \otimes \pi_0  \otimes \sigma)$ we are 
removing $\alpha$ from the update to be memorised in the local store. However, 
since $\alpha$ is added to the global store, it will not be necessary to receive it again in the future. 


\def\ooodiv{\; {\ominus\hspace{-5.7pt} \div} \;}

\begin{remark}
	Concerning the rule ${\bf LA2}$, 
	%the requirement $\alpha \leq \1$ might have been replaced by $\alpha \leq \sigma \odiv \sigma$,
	%still ensuring a strengthening of the store. In view of later results on localised POMs, this choice will be immaterial.
	%
	%More importantly, 
	an alternative solution %for the rule 
	would have been to restrict the possible reductions to the one with maximal label, 
	that is, $\langle \hbox{\ask}(c) \mapsto A, \sigma \rangle \xrightarrow{c \ooodiv \sigma} \langle A, (c \odiv \sigma) \otimes \sigma \rangle$. 
	However, this might have been restrictive in combination with rule ${\bf LR2}$.
	Consider  our running example and the configuration 
	$\langle \exists^{[x > 1]}_x \hbox{\ask}(y > 2) \mapsto \hbox{\ostop}, \monid \rangle$. The initial configuration in the premise is
	$\langle \hbox{\ask}(y > 2) \mapsto \hbox{\ostop}, x > 1 \rangle$ and $(y > 3) \odiv (x > 1) = (x \leq 1) \vee (y > 2)$.
	Selecting $\alpha = (x \leq 1) \vee (y > 2)$ is problematic, since $x$ occurs free. Instead, the choice of $\alpha = (y > 2)$,
	or any other value such as $y > 3$, $y > 4$, $\ldots$, fits well with the intuition of information  from the environment 
	triggering the reduction.
	
	Note instead that the choice of removing the requirement $x \not \in sv(\alpha)$ and put $\exists_x \alpha$ as label in the 
	conclusion of rule ${\bf LR2}$ would  be too liberal. It would work in our previous example, since 
	$\exists_x((x \leq 1) \vee (y > 3)) = y > 3$. However, consider e.g. 
	the configuration $\gamma = \langle \exists^{[x > 1]}_x \hbox{\ask}(x > 2) \mapsto \hbox{\ostop}, \monid \rangle$. 
	We would have that 
	$\langle \hbox{\ask}(x > 2) \mapsto \hbox{\ostop}, x > 1 \rangle \xrightarrow{x \neq 2} \langle \hbox{\ostop}, x > 2 \rangle$,
	and then allowing the reduction $\gamma \xrightarrow{\monid} \langle \exists^{[x > 1, x \neq 2]}_x \hbox{\ostop}, \monid \rangle$,
	which clashes with the intuition that receiving information should not enable reductions involving (necessarily) 
	the restricted variable.
\end{remark}

\begin{lemma}[On labelled monotonicity]
	\label{l-mono}
	Let $\langle A, \sigma \rangle \xrightarrow{\alpha} \langle B, \rho \rangle$ be a labelled reduction. 
	Then 
	%\begin{enumerate}
	$\rho = (\rho \odiv (\alpha \otimes \sigma)) \otimes \alpha \otimes \sigma$ and 
	$fv(\langle B, \rho \rangle) \subseteq fv(\langle A, \sigma \rangle) \cup sv(\alpha)$.
	%\end{enumerate}
	%Moreover, if $\mathbb S$ is localised and $\alpha \neq \monid$ then $\rho \odiv (\alpha \otimes \sigma) = \monid$.
\end{lemma}


\begin{remark}
	We will later prove that if $\mathbb S$ is localised and $\alpha \neq \monid$ then 
	$\rho \odiv (\alpha \otimes \sigma) = \monid$.
	In other terms, if $\langle A, \sigma \rangle \xrightarrow{\alpha} \langle B, \rho \rangle$ 
	is a labelled reduction and $\alpha \neq \monid$, then $\rho = \alpha \otimes \sigma$.
	Indeed, since $\alpha \neq \monid$ its derivation must use the axiom  {\bf LA2}.
	%
	Consider e.g. a labelled reduction 
	$ \langle \exists^\pi_x A, \sigma \rangle \xrightarrow{\alpha}
	\langle \exists^{\pi \rho}_x B, \alpha \otimes \sigma \otimes \exists_x \rho \rangle$.
	%Item $1$ of the lemma above tell us that 
	If $\alpha \neq \monid$, then $\rho = \monid$. 
	Indeed, this is the expected behaviour: if an input from the context is needed,
	there is no contribution by the agent to the local store, hence the update is 
	correctly $\monid$.
\end{remark}

\begin{definition}
	A configuration is l-reachable if it can be
	reached by an initial configuration via a sequence of 
	labelled reductions.
\end{definition}

%We denote as $\xRightarrow{\mu}$ the reflexive and transitive closure of $\xrightarrow{\alpha}$,
%with $\mu \in {\mathcal C}^\ast$ a sequence of elements defined in the expected way: 
%$\xRightarrow{\mu}\ =\ \xrightarrow{\mu} \ldots \xrightarrow{\mu_n}$
%with $\mu = [\mu_1, \ldots, \mu_n]$.

\begin{lemma}[On labelled monotonicity, II]
	\label{l-mono2}
	Let 
	$\langle B \parallel \exists_x^\pi C, \sigma \rangle$ 
	be an l-reachable configuration. 
	Then 
	%\begin{enumerate}
	%\item $\exists \sigma'.\  \sigma = \sigma' \otimes \exists_x \pi$
	%\end{enumerate}
	$\sigma = (\sigma \odiv (\exists_x \pi)_\otimes) \otimes (\exists_x \pi)_\otimes$.
\end{lemma}


\section{Semantics correspondence and labelled bisimilarity}\label{sec:correspondancebis}
We collect further formal results in two different subsections: Section~\ref{sec:corres} proves the correspondence between the two unlabelled and labelled semantics, while Section~\ref{sec:bisimilarity} propose a bisimilarity reduction for the labelled  semantics.

\subsection{On the correspondence between reduction semantics}
\label{sec:corres}
This section shows the connection between labelled and unlabelled reduction semantics.
%We say that a configuration $\gamma$ is reachable if there exists an initial agent $A$ such that
%$\langle A, \sigma \rangle \to^\ast \gamma$, and it is l-reachable if 
%$\langle A, \sigma \rangle \xRightarrow{\mu} \gamma$.
%
%In the following, we assume that $\C$ in invertible.

\begin{theorem}[Soundness]
	\label{sound}
	%Let $\langle A, \sigma \rangle$ be an l-reachable configuration and
	If $\langle A, \sigma \rangle \xrightarrow{\alpha} \langle B, \sigma' \rangle$
	then %$\langle A, \alpha \otimes \sigma \rangle$ is a reachable configuration and
	$\langle A, \alpha \otimes \sigma \rangle \to \langle B, \sigma' \rangle$.
\end{theorem}
\begin{proof}
	We proceed by induction and we will prove a slightly stronger proposition, namely, that the two reductions
	have equivalent proofs, namely, they use axioms and rules in the same order,
	up-to the obvious renaming (i.e., ${\bf LA1}$ for ${\bf A1}$, and so on).
	
	The property holds for the axioms, since e.g. for {\bf LA2} we know that
	$\alpha \leq c \odiv \sigma$ implies $\alpha \otimes \sigma \leq c$ for residuated POMs.
	%
	We then proceed by induction on rule derivations,
	presenting only the proof for rule {\bf LR2}.
	%
	We have 
	$$\frac {\displaystyle \langle A, \pi_0 \otimes \sigma \rangle \xrightarrow{\alpha}
		\langle B, \sigma_1 \rangle \text{ with } \pi_0 = \pi_\otimes \oodiv (\exists_x \pi)_\otimes }
	{\displaystyle \langle \exists^\pi_x A, \sigma \rangle \xrightarrow{\alpha}
		\langle \exists^{\pi \rho}_x B, \alpha \otimes \sigma \otimes \exists_x \rho \rangle  \text{ with } \rho = \sigma_1 \oodiv (\alpha \otimes \pi_0 \otimes \sigma)}$$
	%
	for $x \not \in sv(\sigma) \cup sv(\alpha)$.
	%
	By induction hypothesis $\langle A, \alpha \otimes \pi_0 \otimes \sigma \rangle$ is reachable and
	$$\langle A, \alpha \otimes \pi_0 \otimes \sigma \rangle \to
	\langle B, \sigma_1 \rangle$$
	From this it follows by {\bf LR2} that $\langle \exists^\pi_x A, \alpha \otimes \sigma \rangle$ is reachable and
	$$\langle \exists^\pi_x A, \alpha \otimes \sigma \rangle \to
	\langle \exists^{\pi \rho}_x B, \alpha \otimes \sigma \otimes \exists_x \rho \rangle$$
	and we are done.
	\qed
\end{proof}


The theorem above can be easily reversed, saying that if a configuration $\langle A, \sigma \rangle$ is reachable,
then it is also l-reachable via a sequence of reductions labelled by $\monid$.

\begin{proposition}
	\label{idred}
	If %$\langle A, \sigma \rangle$ be a reachable configuration and
	$\langle A, \sigma \rangle \to \langle B, \sigma' \rangle$
	then %$\langle A, \sigma \rangle$ is an l-reachable configuration and
	$\langle A, \sigma \rangle \xrightarrow{\monid}  \langle B, \sigma' \rangle$.
\end{proposition}



These results also ensure that a configuration is reachable iff it is l-reachable.
%
However, we are interested in a more general notion of completeness, possibly taking into account 
reductions needing a label. For this, we first need some technical lemmas.
% as stated in the theorem below.
%
\comment{
	\begin{lemma}
		\label{minor}
		Let $\langle A, \tau \rangle$ be a reachable configuration such that
		$\sigma \leq \tau$. If $\C$ is invertible then $\langle A, \sigma \rangle$ is a reachable configuration.
		%
		Moreover, if  $\langle A, \tau \rangle \to \langle B, \tau' \rangle$ then
		$\langle A, \sigma \rangle \to \langle B', \sigma' \rangle$ 
		with $\sigma' = \tau' \otimes (\sigma \odiv \tau)$.
		Furthermore, if $\C$ is also cancellative then $B = B'$.
	\end{lemma}
}
%

Now, note that the proof of every (labelled) reduction is given by the choice of an axiom 
and a series of applications of the rules {\bf LR1} and  {\bf LR2}.
Also, note that if 
$\langle A, \sigma \rangle \xrightarrow{\alpha} \langle B, \sigma' \rangle$ is a reduction 
via the axiom {\bf LA1}, then $\alpha = \1$.

\begin{lemma}[Completeness, I]
	\label{LA1}
	Let $\langle A, \tau \rangle \xrightarrow{\monid} \langle B, \tau' \rangle$ be a reduction 
	via the axiom {\bf LA1}. 
	If $\C$ is cancellative then 
	%there exists $\xi$
	%such that $\tau' = \xi \otimes \tau$
	%and 
	for every $\sigma$
	$\langle A, \sigma \rangle \xrightarrow{\monid} \langle B, \sigma' \rangle$
	and $\tau' \odiv \tau = \sigma' \odiv \sigma$.
\end{lemma}


\comment{
	\begin{lemma}
		\label{riminor}
		Let $\langle A, \tau \rangle \xrightarrow{\beta} \langle B, \tau' \rangle$ with $\alpha \leq \beta$. 
		%
		If $\beta \neq \monid$ then $\langle A, \tau \rangle \xrightarrow{\alpha} \langle B, \tau' \otimes (\alpha \odiv \beta) \rangle$.
	\end{lemma}
	
	\todo{questo lemma ora serve?}
	The lemma just states that the label in a reduction can always be strengthened,
	as long as rule  {\bf LA1} is not used in the reduction labelled by $\beta$.
	The proof exploits the premise of rule {\bf LA2} together with Lemma~\ref{l-mono},
	and the condition $\beta \neq \monid$ is required in the inductive step for rule  {\bf LR2}.
}

\begin{lemma}[Completeness, II]
	\label{LA2}
	Let $\langle A, \tau \rangle \xrightarrow{\beta} \langle B, \tau' \rangle$ be a reduction 
	via the axiom {\bf LA2}. If $\C$ is localised then $\tau' = \beta \otimes \tau$
	and for every $\sigma$ if $\alpha \leq (\beta \otimes \tau) \odiv \sigma$ then
	$\langle A, \sigma \rangle \xrightarrow{\alpha} \langle B, \alpha \otimes \sigma \rangle$.
\end{lemma}


Clearly $\alpha = (\beta \otimes \tau) \odiv \sigma$ is a possible witness. Note however that 
it might be that $\beta \otimes \tau \not \leq \alpha \otimes \sigma$,
e.g. if $\sigma = \bot$, in which case $\alpha = \top$.


%




\subsection{Labelled bisimulation}\label{sec:bisimilarity}
We now exploit the labelled reductions in order to define suitable notion of bisimilarity without the upward closure condition.
As it occurs with the crisp language~\cite{pippo} and the soft variant with global variables~\cite{festcatuscia}, 
%and differently from most process calculi~\ref{xxx}, 
barbs cannot be removed from the 
definition of bisimilarity because they cannot be inferred by the reductions.

\begin{definition}[Strong bisimilarity]\label{def:strongbis} A strong bisimulation is a symmetric relation $R$ on configurations such that whenever
	%$(\gamma_1,\gamma_2) \in R$ with $\gamma_1 = \langle A, \sigma \rangle$
	%and $\gamma_2 = \langle B, \rho \rangle$
	$( \langle A, \sigma \rangle,\langle B, \rho \rangle) \in R$
	\begin{enumerate}
		\item if $\langle A, \sigma \rangle \downarrow_c$ then $\langle B, \rho \rangle \downarrow_c$;
		\item if $\langle A, \sigma \rangle \xrightarrow{\alpha} \gamma_1$ then there is $\gamma_2$ such that $\langle B, \alpha \otimes \rho \rangle \to \gamma_2$ 
		and $(\gamma_1, \gamma_2) \in R$;
		\item $(\langle A,\sigma \otimes d\rangle, \langle B,\rho \otimes d \rangle) \in R$ for  all $d$ such that $\sigma \otimes d \not \leq \sigma$. 
	\end{enumerate}
	We say that $\gamma_1$ and $\gamma_2$ are  strongly bisimilar ($\gamma_1  \sim \gamma_2$) if there exists a strong  bisimulation 
	$R$ such that $(\gamma_1 , \gamma_2 ) \in R$. We write $A \sim B$ if $\langle A, \monid \rangle \sim \langle B, \monid \rangle$.
\end{definition}

Note that $\langle A, \sigma \rangle \sim \langle B, \rho \rangle$ implies
$\sigma = \rho$, as for saturated bisimilarity.
%This fact does not hold if we move to weak relations. 
%
\comment{
	\begin{definition}[Weak bisimilarity]\label{def:weakbis} A weak bisimulation is a symmetric relation $R$ on configurations such that whenever
		%$(\gamma_1,\gamma_2) \in R$ with $\gamma_1 = \langle A, \sigma \rangle$
		%and $\gamma_2 = \langle B, \rho \rangle$
		$( \langle A, \sigma \rangle,\langle B, \rho \rangle) \in R$
		\begin{enumerate}
			\item if $\langle A, \sigma \rangle \downarrow_c$ then $\langle B, \rho \rangle \Downarrow_c$;
			\item if $\langle A, \sigma \rangle \xrightarrow{\alpha} \gamma_1$ then there is $\gamma_2$ such that $\langle B, \rho \otimes \alpha \rangle \Rightarrow \gamma_2$ 
			and $(\gamma_1, \gamma_2) \in R$;
		\end{enumerate}
		We say that $\gamma_1$ and $\gamma_2$ are  weakly bisimilar ($\gamma_1  \approx \gamma_2$) if there exists a  
		weak  bisimulation $R$ such that $(\gamma_1 , \gamma_2 ) \in R$. 
		We write $A \approx B$ if $\langle A, \monid \rangle \approx \langle B, \monid \rangle$.
	\end{definition}
	
	\begin{lemma}[Weak bisimilarity, 2]\label{def:weakbis2}
		Weak bisimilarity coincides with the relation 
		obtained from Definition~\ref{def:strongbis} by replacing $\to$ with $\Rightarrow$ and $\downarrow_c$ with $\Downarrow_c$.
	\end{lemma}
	
	\begin{proposition}
		Let $\langle A,\sigma \rangle, \langle B,\rho \rangle$ be configurations 
		and $c, d \in \mathcal{C}$.
		If $\langle A,\sigma \rangle \approx \langle B,\rho \rangle$
		and $\langle A,\sigma \otimes d\rangle \downarrow_c$ then 
		then $\langle B, \rho \otimes d\rangle \Downarrow_c$.
	\end{proposition}
}
%
We improved on the feasibility of $\sim$ by requiring that the equivalence is upward closed 
only whenever the store may be worsened. Note that in some cases, e.g. 
when $\mathcal{C}$ is absorptive (as in  \cite{pippo}), the clause is vacuous. 
%
However, thanks to the correspondence results in Section~\ref{sec:corres}, 
it can be proved upward closed for all $d$, and thus also a congruence.
%
%Recall that a context $C[\cdot]$ is an agent with an placeholder $\cdot$.

\begin{proposition}
	Let $\langle A,\sigma \rangle \sim \langle B,\rho \rangle$ and $d \in \mathcal{C}$.
	If  $\mathcal{C}$ is cancellative then $\langle A,\sigma \otimes d\rangle \sim \langle B,\rho \otimes d \rangle$.
\end{proposition}
\begin{proof}
	We need to show that the relation 
	$R = \{ (\langle A,\sigma \otimes d \rangle, \langle B,\sigma \otimes d \rangle) \mid \langle A,\sigma \rangle \sim \langle B,\sigma \rangle\}$
	is a labelled bisimulation. We then assume that 
	$\langle A, \sigma \otimes d \rangle  \xrightarrow{\beta} \langle A', \sigma' \rangle$: 
	we need to prove that there exists $B'$ such that
	$\langle B,\beta \otimes  \sigma \otimes d \rangle  \xrightarrow{} \langle B', \sigma' \rangle$ 
	and $(\langle A', \sigma' \rangle, \langle B', \sigma' \rangle) \in R$.
	%  Note also that we need to prove it only for those
	
	%
	By soundness 
	$\langle A, \beta \otimes  \sigma \otimes d \rangle  \xrightarrow{}\langle A', \sigma' \rangle$
	with the same proof.
	We then distinguish two cases on the 
	axiom used.
	
	\begin{description}
		\item{[{\bf LA1}]}
		By Lemma~\ref{LA1} (completeness for {\bf LA1}) we have $\langle A,  \sigma \rangle  \xrightarrow{\monid}\langle A', \sigma'' \rangle$
		and $\sigma' \odiv (\beta \otimes \sigma \otimes d) = \sigma'' \odiv \sigma$, and by Lemma~\ref{mono2} (monotonicity)
		we have that $\sigma' = \sigma'' \otimes \beta \otimes d$.
		Since $\langle A,\sigma \rangle \sim \langle B,\sigma \rangle$, 
		there exists $B'$ such that 
		$\langle B, \sigma \rangle \xrightarrow{} \langle B', \sigma'' \rangle$
		and $\langle A', \sigma'' \rangle \sim \langle B', \sigma'' \rangle$,
		and it suffices to look at the cases where $\beta \otimes d \leq \monid$.
		%
		Now $\langle B, \sigma \rangle \xrightarrow{\monid} \langle B', \sigma'' \rangle$, and we may now check the proof of
		such reduction.
		If it is  {\bf LA1}, we retrace the same steps as before and 
		$\langle B, \beta \otimes  \sigma \otimes d \rangle  \xrightarrow{\monid} \langle B', \sigma' \rangle$
		with $\sigma' = \sigma'' \otimes \beta \otimes d$, and we are done.
		%
		If it is  {\bf LA2}, it suffices to note that $\beta \otimes \sigma \otimes d\leq \sigma$,
		hence $\langle B, \sigma \otimes \beta \otimes d \rangle \xrightarrow{\monid} \langle B', \sigma'' \otimes \beta \otimes d\rangle$
		and we are done.
		
		\item{[{\bf LA2}]}
		By Lemma~\ref{LA2} (completeness for {\bf LA2}) we have $\langle A,  \sigma \rangle  \xrightarrow{\alpha}\langle A', \alpha \otimes \sigma \rangle$
		for any $\alpha \leq (\beta \otimes \sigma \otimes d) \odiv \sigma$.
		% thus in particular 
		%$\langle A,  \sigma \rangle  \xrightarrow{\beta \otimes \sigma}\langle A', \beta \otimes \sigma \otimes d \rangle$,
		%thanks to cancellativeness).
		%  
		Since $\langle A,\sigma \rangle \sim \langle B,\sigma \rangle$, 
		there exists $B'$ such that 
		$\langle B, \alpha \otimes \sigma \rangle \xrightarrow{} \langle B', \alpha \otimes \sigma \rangle$,
		and by taking $\alpha = (\beta \otimes \sigma \otimes d) \odiv \sigma$ we are done.
	\end{description}
\end{proof}

As for the unlabelled case (Proposition~\ref{cong1}), strong bisimilarity is a congruence.

\begin{proposition}
	Let $A \sim B$ and $C[\cdot]$ a context.
	If $\mathcal{C}$ is cancellative 
	then $C[A] \sim C[B]$.
\end{proposition}

%\section{On the equivalence between bisimulation semantics}
%
Finally, we can state the correspondence between our bisimilarity semantics.

\begin{theorem}
	$\sim_{\mathit{s}} \subseteq \sim$. Moreover, if $\mathcal{C}$ is cancellative, then the equality holds.
\end{theorem}

%\begin{theorem}
%$\approx_{\mathit{s}}  \subseteq \approx$. Moreover, if $\mathcal{C}$ is invertible, then the equality holds.
%\end{theorem}


\section{Related works}\label{sec:related}
As it is possible to appreciate from the survey in \cite{emerging}, the literature on CCP languages is quite ample. In the following of this section  we briefly summarise proposals that consider both local and global stores, and information mobility.

One of the most related work is represented by \cite{pippo}. Anyhow, the differences are significant: in that work the underlying constraint systems is crisp, as it can only deal with hard constraints (which indeed we can do as well). For this reason, there is no need for defining a \emph{residuated} preference system, which allows us to use bipolar preferences. Furthermore, the authors of \cite{pippo} adopt a cylindric algebra instead of a polyadic one, as introduced in Section~\ref{sec:intro}. Finally, as already noted in Remark~\ref{crisp} in this paper, the use of the local store is different with respect to our approach.
Since the monoidal operator is idempotent, in \cite{pippo} the semantics 
of the hiding operator is simply presented as $\langle 
\exists^{e}_x A, \sigma \rangle \to \langle  \exists^{e'}_x B, \sigma \otimes \exists_x e' \rangle$ if $\langle 
A, e \otimes \exists_x \sigma \rangle \to \langle  B, e' \otimes \exists_x \sigma \rangle$. 
Since we have introduced polyadic operators, with their simpler representation of substitutions, and thus we consider agents up-to $\alpha$-conversion,
we can replace $\exists_x \sigma$ with $\sigma$ by requiring that $x \not \in sv(\sigma)$.
Most importantly, in \cite{pippo} the local store $e$ is used to fire a step that only changes the local store to $e'$, and this change is  visible in the global store except  for the effect on variable $x$. However, this rule is intrinsically non-deterministic, since many such $e'$ can exist. Moreover, since we are not idempotent we cannot add the whole $e'$ to both the local and the global stores, but only the ``difference'' between $e'$ and $e$ at each step. 

In \cite{spatialvalencia} the authors describe a \emph{spatial} constraint systems with operators to
specify information and processes moving from a space to another. Such a language provides for the specification of spatial mobility and epistemic concepts such as belief, utterance and lies: besides local stores for agents  (representing belief), it can express the epistemic notion of knowledge by means of a derived spatial operator that specifies global shared information. Differently from this work, our approach focuses on preferences, on the concurrent language on top of the system, and on process equivalences.

The process calculi in \cite{parrowlics,buscemi} provide  to agents the use of assertions within $\pi$-like processes. A soft language is adopted in \cite{buscemi}: from a variant of $\pi$-calculus it inherits \emph{explicit fusions}, i.e. simple constraints expressing name equalities, in order to pass constraints from an agent to another.
However the algebraic structure is neither residuated nor  polyadic; in addition, no process-equivalence relation is proposed.  In \cite{pi1,pi2}  processes can send constraints using communication channels much like in the $\pi$-calculus. 

A further language that uses $\pi$-calculus features to exchange constraints between agents, but this time with a probabilistic semantics, is shown in \cite{bortolussi}. A congruence relation and a labelled transition system are also shown in the paper. 

In \cite{catuscia} the authors propose an extension of the CCP language with the purpose to model process migration within a hierarchical network. Agents brings their local store when they migrate. In \cite{lubos} the authors enrich a CCP language with the possibility to share (read/write) the information in the global store, and communicate with other agents (via multi-party or handshake).

All the systems described in this section are based on hard constraints, and  they do not consider preferences associated with constraints (except \cite{buscemi}, whose algebraic structure is however less general). In addition, a very few proposals formalise process equivalences by providing a deeper investigation of the semantics.





\section{Conclusions and further works}\label{sec:conclusion}



\todo[inline]{To be finished}





\bibliographystyle{splncs03}%splncs
\bibliography{main,softccp}


	\section*{Appendix}
	
	\setcounter{lemma}{7}
	\begin{lemma}[On monotonicity]
		\label{rmono}
		Let $\langle A, \sigma \rangle \rightarrow \langle B, \rho \rangle$ be a reduction. 
		Then $\rho = (\rho \odiv \sigma) \otimes \sigma$ and $fv(\langle B, \rho \rangle) \subseteq fv(\langle A, \sigma \rangle)$.
		%\begin{enumerate}
		%\item $\exists \sigma''.\  \sigma' = \sigma'' \otimes \sigma$
		%\item $fv(\langle B, \sigma' \rangle) \subseteq fv(\langle A, \sigma \rangle)$
		%\end{enumerate}
	\end{lemma}
	
	%By the properties of residuation, a witness of the equality in item $1$ is
	%$\sigma' \odiv \sigma$.
	
	\begin{proof}
		Thanks to the equivalence $((a \otimes b) \odiv b) \otimes b = a \otimes b$, which holds in residuated POMs,
		it is easy to check that the first law is preserved by reductions,
		in particular by axiom \mbox{\bf A1} and rule \mbox{\bf R2}.
		The second law is proved by induction on rule application.
		\qed
	\end{proof}
	
	
	\setcounter{lemma}{8}
	\begin{lemma}[On monotonicity, II]
		\label{mono2}
		Let $\langle A \parallel \exists_x^\pi B, \sigma \rangle$ 
		be a reachable configuration.
		Then $\sigma = (\sigma \odiv (\exists_x \pi)_\otimes) \otimes (\exists_x \pi)_\otimes$.
		%\begin{enumerate}
		%\item $\exists \sigma'.\  \sigma = \sigma' \otimes (\exists_x \pi)_\otimes$
		%\end{enumerate}
	\end{lemma}
	\begin{proof}[to be done better]
		We prove an equivalent property, namely, that there is $\sigma'$ such that 
		$\sigma = \sigma' \otimes (\exists_x \pi)_\otimes$. 
		%
		It holds for initial configurations, and since it is clearly preserved by reductions, 
		in particular by those obtained by axiom \mbox{\bf A1} and rule \mbox{\bf R2},
		then we are done.
		\qed
		%
		%As for \mbox{\bf A1}, it suffices to prove that $(\sigma \odiv a) \otimes a = \sigma$ implies  
		%$((\sigma \otimes c) \odiv a) \otimes a = \sigma \otimes c$. Now, 
		%$((\sigma \otimes c) \odiv a) \otimes a \leq \sigma \otimes c$ always holds. 
		%For the reverse, by hypothesis and monotonicity  
		%$(\sigma \odiv a) \otimes a \otimes c \geq \sigma \otimes c$, so it suffices to prove that 
		%$((\sigma \otimes c) \odiv a) \otimes a \geq (\sigma \odiv a) \otimes a \otimes c$.
		%This is in turn implied by $((\sigma \otimes c) \odiv a) \geq (\sigma \odiv a) \otimes c$.
	\end{proof}
	
	
	\setcounter{lemma}{9}
	\begin{lemma}[On labelled monotonicity]
		\label{l-mono}
		Let $\langle A, \sigma \rangle \xrightarrow{\alpha} \langle B, \rho \rangle$ be a labelled reduction. 
		Then 
		%\begin{enumerate}
		$\rho = (\rho \odiv (\alpha \otimes \sigma)) \otimes \alpha \otimes \sigma$ and 
		$fv(\langle B, \rho \rangle) \subseteq fv(\langle A, \sigma \rangle) \cup sv(\alpha)$.
		%\end{enumerate}
		%Moreover, if $\mathbb S$ is localised and $\alpha \neq \monid$ then $\rho \odiv (\alpha \otimes \sigma) = \monid$.
	\end{lemma}
	\begin {proof}
	Immediate as for Lemma~\ref{mono}.
	\comment{
		The first part is immediate as for Lemma~\ref{mono}.
		%
		For the latter part, note that $\alpha \neq 1$ means that the proof of the reduction 
		uses only the axiom {\bf LA2}, and the property holds because 
		$\mathbb S$ is localised and $\rho = \alpha \otimes \sigma$.
		%
		Let us check that the property 
		holds for {\bf LR2}. Inductively, we know that 
		$(\sigma_1 \odiv (\alpha \otimes \pi_0 \otimes \sigma)) = \monid$, and
		$(\alpha \otimes \sigma \otimes \exists_x ( \sigma_1 \odiv (\alpha \otimes \pi_0  \otimes \sigma))) \odiv (\alpha \otimes \sigma) = \monid$
		immediately follows.
	}
	\qed
\end{proof}

\setcounter{lemma}{10}
\begin{lemma}[On labelled monotonicity, II]
	\label{l-mono2}
	Let 
	$\langle B \parallel \exists_x^\pi C, \sigma \rangle$ 
	be an l-reachable configuration. 
	Then 
	%\begin{enumerate}
	%\item $\exists \sigma'.\  \sigma = \sigma' \otimes \exists_x \pi$
	%\end{enumerate}
	$\sigma = (\sigma \odiv (\exists_x \pi)_\otimes) \otimes (\exists_x \pi)_\otimes$.
\end{lemma}
\begin{proof}
	\todo{riguardare}
	As for unabelled reductions, it is easy to show that the equivalent property
	on the existence of $\sigma'$ such that 
	$\sigma = \sigma' \otimes (\exists_x \pi)_\otimes$ is preserved by 
	labelled reductions. 
	\qed
\end{proof}

\setcounter{theorem}{0}
\begin{theorem}[Soundness]
	\label{sound}
	%Let $\langle A, \sigma \rangle$ be an l-reachable configuration and
	If $\langle A, \sigma \rangle \xrightarrow{\alpha} \langle B, \sigma' \rangle$
	then %$\langle A, \alpha \otimes \sigma \rangle$ is a reachable configuration and
	$\langle A, \alpha \otimes \sigma \rangle \to \langle B, \sigma' \rangle$.
\end{theorem}

\begin{proof}
	We proceed by induction and we will prove a slightly stronger proposition, namely, that the two reductions
	have equivalent proofs, namely, they use axioms and rules in the same order,
	up-to the obvious renaming (i.e., ${\bf LA1}$ for ${\bf A1}$, and so on).
	
	The property holds for the axioms, since e.g. for {\bf LA2} we know that
	$\alpha \leq c \odiv \sigma$ implies $\alpha \otimes \sigma \leq c$ for residuated POMs.
	%
	We then proceed by induction on rule derivations,
	presenting only the proof for rule {\bf LR2}.
	%
	We have 
	$$\frac {\displaystyle \langle A, \pi_0 \otimes \sigma \rangle \xrightarrow{\alpha}
		\langle B, \sigma_1 \rangle \text{ with } \pi_0 = \pi_\otimes \oodiv (\exists_x \pi)_\otimes }
	{\displaystyle \langle \exists^\pi_x A, \sigma \rangle \xrightarrow{\alpha}
		\langle \exists^{\pi \rho}_x B, \alpha \otimes \sigma \otimes \exists_x \rho \rangle  \text{ with } \rho = \sigma_1 \oodiv (\alpha \otimes \pi_0 \otimes \sigma)}$$
	%
	for $x \not \in sv(\sigma) \cup sv(\alpha)$.
	%
	By induction hypothesis $\langle A, \alpha \otimes \pi_0 \otimes \sigma \rangle$ is reachable and
	$$\langle A, \alpha \otimes \pi_0 \otimes \sigma \rangle \to
	\langle B, \sigma_1 \rangle$$
	From this it follows by {\bf LR2} that $\langle \exists^\pi_x A, \alpha \otimes \sigma \rangle$ is reachable and
	$$\langle \exists^\pi_x A, \alpha \otimes \sigma \rangle \to
	\langle \exists^{\pi \rho}_x B, \alpha \otimes \sigma \otimes \exists_x \rho \rangle$$
	and we are done.
	\qed
\end{proof}

\setcounter{lemma}{11}
\begin{lemma}
	\label{idred}
	If %$\langle A, \sigma \rangle$ be a reachable configuration and
	$\langle A, \sigma \rangle \to \langle B, \sigma' \rangle$
	then %$\langle A, \sigma \rangle$ is an l-reachable configuration and
	$\langle A, \sigma \rangle \xrightarrow{\monid}  \langle B, \sigma' \rangle$.
\end{lemma}
\begin{proof}
	Only axiom  {\bf LA2} needs to be checked, and it is obvious, since $\sigma \leq c$ implies that 
	$\monid \leq c \odiv \sigma$ and thus 
	$\langle \hbox{\ask}(c) \mapsto A, \sigma \rangle \xrightarrow{\monid}
	\langle A, \monid \otimes \sigma \rangle$.
\end{proof}	

\begin{lemma}
	\label{LA1}
	Let $\langle A, \tau \rangle \xrightarrow{\monid} \langle B, \tau' \rangle$ be a reduction 
	via the axiom {\bf LA1}. 
	If $\C$ is cancellative then 
	%there exists $\xi$
	%such that $\tau' = \xi \otimes \tau$
	%and 
	for every $\sigma$
	$\langle A, \sigma \rangle \xrightarrow{\monid} \langle B, \sigma' \rangle$
	and $\tau' \odiv \tau = \sigma' \odiv \sigma$.
\end{lemma}
\begin{proof}
	For the axiom {\bf LA1} it is obvious,
	thanks to cancellativeness.
	As for the inductive step, the proof for 
	{\bf LR1} is obvious. For {\bf LR2},
	just note that by hypothesis 
	$\rho = \tau_1 \odiv (\pi_0 \otimes \tau) = \sigma_1 \odiv (\pi_0 \otimes \sigma)$
	and by cancellativeness 
	$(\tau \otimes \exists_x \rho) \odiv \tau = (\sigma \otimes \exists_x \rho) \odiv \sigma$.
	\qed
\end{proof}


\begin{lemma}
	\label{LA2}
	Let $\langle A, \tau \rangle \xrightarrow{\beta} \langle B, \tau' \rangle$ be a reduction 
	via the axiom {\bf LA2}. If $\C$ is localised then $\tau' = \beta \otimes \tau$
	and for every $\sigma$ if $\alpha \leq (\beta \otimes \tau) \odiv \sigma$ then
	$\langle A, \sigma \rangle \xrightarrow{\alpha} \langle B, \alpha \otimes \sigma \rangle$
	%for any $\alpha \leq \xi$.
	%\begin{enumerate}
	%\item there exists $\alpha$ such that
	%$\langle A, \sigma \rangle \xrightarrow{\alpha} \langle B, \alpha \otimes \sigma \rangle$
	%and $(\beta \otimes \tau) \odiv \sigma \leq \alpha$;
	%\item for every $\alpha$ if $\alpha \leq (\beta \otimes \tau) \odiv \sigma$ then 
	%$\langle A, \sigma \rangle \xrightarrow{\alpha} \langle B, \alpha \otimes \sigma \rangle$.
	%\end{enumerate}
	%
	%Moreover, if  $\langle A, \tau \rangle \to \langle B, \tau' \rangle$ then
	%$\langle A, \sigma \rangle \to \langle B, \sigma' \rangle$, 
	%with $\sigma' = \tau' \otimes (\sigma \odiv \tau)$.
\end{lemma}
\begin{proof}
	Let $\langle \hbox{\ask}(c) \mapsto B, \tau \rangle \xrightarrow{\beta} \langle A, c \otimes \tau \rangle$.
	Since $\beta \leq c \odiv \tau$ implies 
	%$\beta \otimes \tau \leq c$
	%, hence item $2$ holds.
	%As for item $1$,  $\beta \otimes \tau \leq c$ 
	%in turn implies 
	$(\beta \otimes \tau)\odiv \sigma \leq c \odiv \sigma$,
	%thus with $\xi = c \odiv \sigma$ 
	we are done.
	As for the inductive step, the proof for 
	{\bf LR1} is obvious. For {\bf LR2},
	it suffices to note that by hypothesis 
	$\tau_1 = \beta \otimes \tau$ and $\sigma_1 = \alpha \otimes \sigma$
	and by locality 
	$\tau_1 \odiv (\beta \otimes \pi_0 \otimes \tau) = \monid = \sigma_1 \odiv (\alpha \otimes \pi_0 \otimes \sigma)$.
	%thus any $\alpha$ in the interval will do.
	\qed
\end{proof}

\setcounter{proposition}{1}
\begin{proposition}
	Let $\langle A,\sigma \rangle \sim \langle B,\rho \rangle$ and $d \in \mathcal{C}$.
	If  $\mathcal{C}$ is cancellative then $\langle A,\sigma \otimes d\rangle \sim \langle B,\rho \otimes d \rangle$.
\end{proposition}
\begin{proof}
	We need to show that the relation 
	$R = \{ (\langle A,\sigma \otimes d \rangle, \langle B,\sigma \otimes d \rangle) \mid \langle A,\sigma \rangle \sim \langle B,\sigma \rangle\}$
	is a labelled bisimulation. We then assume that 
	$\langle A, \sigma \otimes d \rangle  \xrightarrow{\beta} \langle A', \sigma' \rangle$: 
	we need to prove that there exists $B'$ such that
	$\langle B,\beta \otimes  \sigma \otimes d \rangle  \xrightarrow{} \langle B', \sigma' \rangle$ 
	and $(\langle A', \sigma' \rangle, \langle B', \sigma' \rangle) \in R$.
	%  Note also that we need to prove it only for those
	
	%
	By soundness 
	$\langle A, \beta \otimes  \sigma \otimes d \rangle  \xrightarrow{}\langle A', \sigma' \rangle$
	with the same proof.
	We then distinguish two cases on the 
	axiom used.
	
	\begin{description}
		\item{[{\bf LA1}]}
		By Lemma~\ref{LA1} (completeness for {\bf LA1}) we have $\langle A,  \sigma \rangle  \xrightarrow{\monid}\langle A', \sigma'' \rangle$
		and $\sigma' \odiv (\beta \otimes \sigma \otimes d) = \sigma'' \odiv \sigma$, and by Lemma~\ref{mono2} (monotonicity)
		we have that $\sigma' = \sigma'' \otimes \beta \otimes d$.
		Since $\langle A,\sigma \rangle \sim \langle B,\sigma \rangle$, 
		there exists $B'$ such that 
		$\langle B, \sigma \rangle \xrightarrow{} \langle B', \sigma'' \rangle$
		and $\langle A', \sigma'' \rangle \sim \langle B', \sigma'' \rangle$,
		and it suffices to look at the cases where $\beta \otimes d \leq \monid$.
		%
		Now $\langle B, \sigma \rangle \xrightarrow{\monid} \langle B', \sigma'' \rangle$, and we may now check the proof of
		such reduction.
		If it is  {\bf LA1}, we retrace the same steps as before and 
		$\langle B, \beta \otimes  \sigma \otimes d \rangle  \xrightarrow{\monid} \langle B', \sigma' \rangle$
		with $\sigma' = \sigma'' \otimes \beta \otimes d$, and we are done.
		%
		If it is  {\bf LA2}, it suffices to note that $\beta \otimes \sigma \otimes d\leq \sigma$,
		hence $\langle B, \sigma \otimes \beta \otimes d \rangle \xrightarrow{\monid} \langle B', \sigma'' \otimes \beta \otimes d\rangle$
		and we are done.
		
		\item{[{\bf LA2}]}
		By Lemma~\ref{LA2} (completeness for {\bf LA2}) we have $\langle A,  \sigma \rangle  \xrightarrow{\alpha}\langle A', \alpha \otimes \sigma \rangle$
		for any $\alpha \leq (\beta \otimes \sigma \otimes d) \odiv \sigma$.
		% thus in particular 
		%$\langle A,  \sigma \rangle  \xrightarrow{\beta \otimes \sigma}\langle A', \beta \otimes \sigma \otimes d \rangle$,
		%thanks to cancellativeness).
		%  
		Since $\langle A,\sigma \rangle \sim \langle B,\sigma \rangle$, 
		there exists $B'$ such that 
		$\langle B, \alpha \otimes \sigma \rangle \xrightarrow{} \langle B', \alpha \otimes \sigma \rangle$,
		and by taking $\alpha = (\beta \otimes \sigma \otimes d) \odiv \sigma$ we are done.
	\end{description}
\end{proof}




\begin{theorem}
	$\sim_{\mathit{s}} \subseteq \sim$. Moreover, if $\mathcal{C}$ is cancellative, then the equality holds.
\end{theorem}
\begin{proof} 
	
	TO DO (ma torna)
\end{proof}


\section*{References} \label{}
\bibliographystyle{elsarticle-num}
\bibliography{main,softccp}

%\newpage
%\subfile{appendix.tex}

\end{document}
